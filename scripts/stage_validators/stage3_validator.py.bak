"""
Stage 3 é©—è­‰å™¨ - åº§æ¨™ç³»çµ±è½‰æ›å±¤ (v3.0 æ¶æ§‹) (é‡æ§‹ç‰ˆæœ¬)

ä½¿ç”¨ StageValidator åŸºé¡çµ±ä¸€é©—è­‰æµç¨‹

Layer 2 é©—è­‰: æª¢æŸ¥é©—è­‰å¿«ç…§çš„åˆç†æ€§èˆ‡æ¶æ§‹åˆè¦æ€§
ä¿¡ä»» Layer 1 (Stage3Processor.run_validation_checks) çš„è©³ç´°é©—è­‰çµæœ

Author: Orbit Engine Refactoring Team
Date: 2025-10-12 (Phase 2 Refactoring)
Original: 2025-10-03
"""

from .base_validator import StageValidator
from typing import Tuple


class Stage3Validator(StageValidator):
    """
    Stage 3 é©—è­‰å™¨ - åº§æ¨™ç³»çµ±è½‰æ›å±¤ (v3.0 æ¶æ§‹: ç´”åº§æ¨™è½‰æ›)

    æª¢æŸ¥é …ç›®:
    - v3.0 æ¶æ§‹åˆè¦æ€§ (ç´”åº§æ¨™è½‰æ›ï¼ŒTEME â†’ WGS84)
    - 5 é …å°ˆç”¨é©—è­‰æ¡†æ¶åŸ·è¡Œæƒ…æ³
    - åº§æ¨™è½‰æ›ç²¾åº¦ (< 100m)
    - Skyfield å°ˆæ¥­åº«ä½¿ç”¨
    - IAU æ¨™æº–åˆè¦æ€§
    - åº§æ¨™ç³»çµ±è½‰æ›é…ç½®
    """

    def __init__(self):
        super().__init__(
            stage_number=3,
            stage_identifier='stage3_coordinate_transformation'
        )

    def perform_stage_specific_validation(self, snapshot_data: dict) -> Tuple[bool, str]:
        """
        Stage 3 å°ˆç”¨é©—è­‰

        æª¢æŸ¥é …ç›®:
        - åº§æ¨™è½‰æ›ç²¾åº¦é©—è­‰
        - åº§æ¨™ç³»çµ±è½‰æ›é…ç½® (TEME â†’ WGS84)
        - Skyfield å’Œ IAU æ¨™æº–åˆè¦æ€§
        - è¡›æ˜Ÿæ•¸é‡å’Œåº§æ¨™é»æ•¸é‡

        Args:
            snapshot_data: é©—è­‰å¿«ç…§æ•¸æ“š

        Returns:
            tuple: (validation_passed: bool, message: str)
        """
        # æª¢æŸ¥é©—è­‰çµæœæ˜¯å¦å­˜åœ¨
        if 'validation_results' not in snapshot_data:
            # èˆŠæ ¼å¼å…¼å®¹: æª¢æŸ¥ status å’Œ data_summary
            return self._validate_legacy_format(snapshot_data)

        validation_results = snapshot_data['validation_results']

        # æª¢æŸ¥åº§æ¨™è½‰æ›ç²¾åº¦
        checks = validation_results.get('checks', {})
        coord_accuracy_check = checks.get('coordinate_transformation_accuracy', {})
        avg_accuracy_m = coord_accuracy_check.get('average_accuracy_m', 999.9)

        # ç²¾åº¦é©—è­‰: < 100m (å–æ¨£æ¨¡å¼ä¸‹åˆç†ï¼Œå°å¯è¦‹æ€§åˆ†æè¶³å¤ )
        if avg_accuracy_m >= 100.0:
            return False, f"âŒ Stage 3 åº§æ¨™è½‰æ›ç²¾åº¦ä¸è¶³: {avg_accuracy_m:.3f}m (è¦æ±‚ < 100m)"

        # æª¢æŸ¥æ•¸æ“šæ‘˜è¦
        data_summary = snapshot_data.get('data_summary', {})
        satellites_processed = data_summary.get('satellites_processed', 0)
        coord_points = data_summary.get('coordinate_points_count', 0)

        # ä½¿ç”¨å·¥å…·æ–¹æ³•æª¢æŸ¥
        if satellites_processed == 0:
            return False, "âŒ Stage 3 æœªè™•ç†ä»»ä½•è¡›æ˜Ÿæ•¸æ“š"

        if coord_points == 0:
            return False, "âŒ Stage 3 æœªç”Ÿæˆä»»ä½•åº§æ¨™é»"

        # æª¢æŸ¥ metadata å­¸è¡“æ¨™æº–åˆè¦æ€§
        metadata = snapshot_data.get('metadata', {})

        # Skyfield å°ˆæ¥­åº«ä½¿ç”¨ç¢ºèª (æ”¯æ´å…©ç¨®æ ¼å¼)
        skyfield_used = metadata.get('skyfield_used', metadata.get('skyfield_config', False))
        if not skyfield_used:
            return False, "âŒ Stage 3 Skyfield æœªä½¿ç”¨"

        # IAU æ¨™æº–åˆè¦æ¨™è¨˜ (æ”¯æ´å…©ç¨®æ ¼å¼)
        iau_compliance = metadata.get('iau_compliant', metadata.get('iau_standard_compliance', False))
        if not iau_compliance:
            return False, "âŒ Stage 3 IAU æ¨™æº–åˆè¦æ¨™è¨˜ç¼ºå¤±"

        # æª¢æŸ¥åº§æ¨™ç³»çµ±è½‰æ›é…ç½® (æ”¯æ´å…©ç¨®æ ¼å¼)
        source_frame = metadata.get('source_frame', '')
        target_frame = metadata.get('target_frame', '')

        # èˆŠæ ¼å¼ï¼šåœ¨ transformation_config ä¸­
        if not source_frame or not target_frame:
            transformation_config = metadata.get('transformation_config', {})
            source_frame = transformation_config.get('source_frame', '')
            target_frame = transformation_config.get('target_frame', '')

        if source_frame != 'TEME':
            return False, f"âŒ Stage 3 æºåº§æ¨™ç³»çµ±éŒ¯èª¤: {source_frame} (æœŸæœ›: TEME)"

        if not target_frame.startswith('WGS84'):
            return False, f"âŒ Stage 3 ç›®æ¨™åº§æ¨™ç³»çµ±éŒ¯èª¤: {target_frame} (æœŸæœ›: WGS84*)"

        # æ§‹å»ºæˆåŠŸè¨Šæ¯
        validation_details = validation_results.get('validation_details', {})
        checks_passed = validation_details.get('checks_passed',
                                              validation_results.get('checks_passed', 0))
        checks_performed = validation_details.get('checks_performed',
                                                 validation_results.get('checks_performed', 0))

        status_msg = (
            f"âœ… Stage 3 åº§æ¨™è½‰æ›æª¢æŸ¥é€šé: "
            f"é©—è­‰æ¡†æ¶ {checks_passed}/{checks_performed} é …é€šé | "
            f"{satellites_processed}é¡†è¡›æ˜Ÿ â†’ {coord_points}å€‹åº§æ¨™é» | "
            f"ç²¾åº¦ {avg_accuracy_m:.3f}m | "
            f"[Skyfieldâœ“, IAUâœ“, Grade_Aâœ“, TEMEâ†’WGS84âœ“]"
        )

        return True, status_msg

    def _validate_legacy_format(self, snapshot_data: dict) -> Tuple[bool, str]:
        """
        é©—è­‰èˆŠæ ¼å¼å¿«ç…§ (v3.0 æ¶æ§‹å…¼å®¹)

        Args:
            snapshot_data: é©—è­‰å¿«ç…§æ•¸æ“š

        Returns:
            tuple: (validation_passed: bool, message: str)
        """
        if snapshot_data.get('status') != 'success':
            status = snapshot_data.get('status', 'unknown')
            return False, f"âŒ Stage 3 åŸ·è¡Œç‹€æ…‹ç•°å¸¸: {status}"

        # v3.0 ä¿®æ­£: Stage 3 åªè² è²¬åº§æ¨™è½‰æ›ï¼Œä¸æ¶‰åŠ 3GPP äº‹ä»¶
        data_summary = snapshot_data.get('data_summary', {})
        satellites_processed = data_summary.get('satellites_processed', 0)
        coord_points = data_summary.get('coordinate_points_count', 0)

        if satellites_processed > 0 and coord_points > 0:
            return True, f"âœ… Stage 3 åº§æ¨™è½‰æ›æª¢æŸ¥é€šé: {satellites_processed}é¡†è¡›æ˜Ÿ â†’ {coord_points}å€‹WGS84åº§æ¨™é»"
        elif satellites_processed > 0:
            # å…¼å®¹èˆŠæ ¼å¼: åªæœ‰è¡›æ˜Ÿæ•¸é‡
            return True, f"âœ… Stage 3 åº§æ¨™è½‰æ›æª¢æŸ¥é€šé: è™•ç†{satellites_processed}é¡†è¡›æ˜Ÿ"
        else:
            return False, f"âŒ Stage 3 åº§æ¨™è½‰æ›æ•¸æ“šä¸è¶³: {satellites_processed}é¡†è¡›æ˜Ÿ"


# ============================================================
# å‘å¾Œå…¼å®¹å‡½æ•¸ (ä¿ç•™åŸå§‹æ¥å£)
# ============================================================

def check_stage3_validation(snapshot_data: dict) -> tuple:
    """
    Stage 3 å°ˆç”¨é©—è­‰ - åº§æ¨™ç³»çµ±è½‰æ›å±¤ (v3.0 æ¶æ§‹: ç´”åº§æ¨™è½‰æ›)

    âš ï¸ å‘å¾Œå…¼å®¹å‡½æ•¸: å…§éƒ¨èª¿ç”¨ Stage3Validator é¡

    æª¢æŸ¥é …ç›®:
    - v3.0 æ¶æ§‹åˆè¦æ€§ (ç´”åº§æ¨™è½‰æ›ï¼ŒTEME â†’ WGS84)
    - 5 é …å°ˆç”¨é©—è­‰æ¡†æ¶åŸ·è¡Œæƒ…æ³
    - åº§æ¨™è½‰æ›ç²¾åº¦ (< 100m)
    - Skyfield å°ˆæ¥­åº«ä½¿ç”¨
    - IAU æ¨™æº–åˆè¦æ€§
    - åº§æ¨™ç³»çµ±è½‰æ›é…ç½®

    Args:
        snapshot_data: é©—è­‰å¿«ç…§æ•¸æ“š

    Returns:
        tuple: (validation_passed: bool, message: str)

    Raises:
        RuntimeError: é©—è­‰å™¨é‚è¼¯éŒ¯èª¤æ™‚æ‹‹å‡º
    """
    try:
        validator = Stage3Validator()
        return validator.validate(snapshot_data)
    except Exception as e:
        # ğŸš¨ Fail-Fast: é©—è­‰é‚è¼¯ç•°å¸¸æ™‚æ‡‰è©²æ‹‹å‡º
        raise RuntimeError(
            f"Stage 3 é©—è­‰å™¨é‚è¼¯éŒ¯èª¤\n"
            f"é€™è¡¨ç¤ºé©—è­‰å™¨ä»£ç¢¼æœ¬èº«æœ‰å•é¡Œ\n"
            f"è©³ç´°éŒ¯èª¤: {e}"
        ) from e
