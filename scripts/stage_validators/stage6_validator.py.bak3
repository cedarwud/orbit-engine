"""
Stage 6 é©—è­‰å™¨ - ç ”ç©¶æ•¸æ“šç”Ÿæˆèˆ‡å„ªåŒ–å±¤ (é‡æ§‹ç‰ˆæœ¬)

ä½¿ç”¨ StageValidator åŸºé¡çµ±ä¸€é©—è­‰æµç¨‹

Layer 2 é©—è­‰: æª¢æŸ¥é©—è­‰å¿«ç…§çš„åˆç†æ€§èˆ‡æ¶æ§‹åˆè¦æ€§
ä¿¡ä»» Layer 1 (Stage6Processor.run_validation_checks) çš„è©³ç´°é©—è­‰çµæœ

Author: Orbit Engine Refactoring Team
Date: 2025-10-12 (Phase 2 Refactoring)
Original: 2025-10-03
"""

from .base_validator import StageValidator
from typing import Tuple


class Stage6Validator(StageValidator):
    """
    Stage 6 é©—è­‰å™¨ - ç ”ç©¶æ•¸æ“šç”Ÿæˆèˆ‡å„ªåŒ–å±¤

    æª¢æŸ¥é …ç›®:
    - 5 é …å°ˆç”¨é©—è­‰æ¡†æ¶åŸ·è¡Œæƒ…æ³
    - 3GPP NTN äº‹ä»¶æª¢æ¸¬ (A3/A4/A5/D2)
    - ML è¨“ç·´æ•¸æ“šç”Ÿæˆ
    - å‹•æ…‹æ± ç¶­æŒé©—è­‰
    - å¯¦æ™‚æ±ºç­–æ€§èƒ½
    """

    def __init__(self):
        super().__init__(
            stage_number=6,
            stage_identifier='stage6_research_optimization'
        )

    def perform_stage_specific_validation(self, snapshot_data: dict) -> Tuple[bool, str]:
        """
        Stage 6 å°ˆç”¨é©—è­‰

        æª¢æŸ¥é …ç›®:
        - 3GPP äº‹ä»¶æª¢æ¸¬æ•¸é‡ (A3, A4, A5, D2)
        - ML è¨“ç·´æ•¸æ“šç”Ÿæˆ
        - æ± é©—è­‰é€šéç‹€æ…‹
        - æ±ºç­–æ€§èƒ½æŒ‡æ¨™

        Args:
            snapshot_data: é©—è­‰å¿«ç…§æ•¸æ“š

        Returns:
            tuple: (validation_passed: bool, message: str)
        """
        # æª¢æŸ¥æ ¸å¿ƒæŒ‡æ¨™
        metadata = snapshot_data.get('metadata', {})
        events_detected = metadata.get('total_events_detected', 0)
        ml_samples = metadata.get('ml_training_samples', 0)
        pool_verified = metadata.get('pool_verification_passed', False)

        # æª¢æŸ¥ 3GPP äº‹ä»¶
        gpp_events = snapshot_data.get('gpp_events', {})
        a3_count = len(gpp_events.get('a3_events', []))
        a4_count = len(gpp_events.get('a4_events', []))
        a5_count = len(gpp_events.get('a5_events', []))
        d2_count = len(gpp_events.get('d2_events', []))

        # æª¢æŸ¥ ML è¨“ç·´æ•¸æ“š
        ml_training_data = snapshot_data.get('ml_training_data', {})
        dataset_summary = ml_training_data.get('dataset_summary', {})
        total_samples = dataset_summary.get('total_samples', 0)

        # æª¢æŸ¥å¯¦æ™‚æ±ºç­–æ€§èƒ½
        decision_support = snapshot_data.get('decision_support', {})
        performance_metrics = decision_support.get('performance_metrics', {})
        avg_latency = performance_metrics.get('average_decision_latency_ms', 999.9)

        # æ§‹å»ºæˆåŠŸè¨Šæ¯ï¼ˆåŸºé¡å·²è™•ç†é©—è­‰æ¡†æ¶é€šéç‹€æ…‹ï¼‰
        mode_indicator = "ğŸ§ª å–æ¨£æ¨¡å¼" if self._is_sampling_mode(snapshot_data) else ""

        status_msg = (
            f"âœ… Stage 6 ç ”ç©¶æ•¸æ“šç”Ÿæˆæª¢æŸ¥é€šé {mode_indicator}: "
            f"3GPPäº‹ä»¶ {events_detected}å€‹ (A3:{a3_count}, A4:{a4_count}, A5:{a5_count}, D2:{d2_count}) | "
            f"MLæ¨£æœ¬ {total_samples}å€‹ | "
            f"æ± é©—è­‰ {'âœ“' if pool_verified else 'âœ—'} | "
            f"æ±ºç­–å»¶é² {avg_latency:.1f}ms"
        )

        return True, status_msg

    def _is_sampling_mode(self, snapshot_data: dict) -> bool:
        """
        Stage 6 å–æ¨£æ¨¡å¼åˆ¤æ–·

        åŸºæ–¼å€™é¸è¡›æ˜Ÿæ•¸é‡åˆ¤æ–·:
        - < 10 é¡†å€™é¸è¡›æ˜Ÿ â†’ å–æ¨£æ¨¡å¼
        - æˆ–ç’°å¢ƒè®Šæ•¸ ORBIT_ENGINE_TEST_MODE=1
        """
        pool_verification = snapshot_data.get('pool_verification', {})
        starlink_pool = pool_verification.get('starlink_pool', {})
        candidate_satellites_total = starlink_pool.get('candidate_satellites_total', 0)

        # å€™é¸è¡›æ˜Ÿå°‘æ–¼ 10 é¡†è¦–ç‚ºå–æ¨£æ¨¡å¼
        if candidate_satellites_total < 10:
            return True

        # æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
        return super()._is_sampling_mode(snapshot_data)

    def _build_success_message(self, snapshot_data: dict, validation_results: dict) -> Tuple[bool, str]:
        """
        è¦†è“‹åŸºé¡æ–¹æ³•ï¼Œæ§‹å»ºè©³ç´°çš„æˆåŠŸè¨Šæ¯

        Args:
            snapshot_data: é©—è­‰å¿«ç…§æ•¸æ“š
            validation_results: é©—è­‰çµæœæ•¸æ“š

        Returns:
            tuple: (True, detailed_message)
        """
        # ç²å–é©—è­‰æ¡†æ¶çµ±è¨ˆ
        validation_details = validation_results.get('validation_details', {})
        checks_passed = validation_details.get('checks_passed',
                                              validation_results.get('checks_passed', 0))
        checks_performed = validation_details.get('checks_performed',
                                                 validation_results.get('checks_performed', 0))

        # èª¿ç”¨å°ˆç”¨é©—è­‰ç²å–è©³ç´°è¨Šæ¯
        _, detailed_msg = self.perform_stage_specific_validation(snapshot_data)

        # æ·»åŠ é©—è­‰æ¡†æ¶ä¿¡æ¯
        full_msg = f"{detailed_msg} | é©—è­‰æ¡†æ¶ {checks_passed}/{checks_performed} é …é€šé"

        return True, full_msg


# ============================================================
# å‘å¾Œå…¼å®¹å‡½æ•¸ (ä¿ç•™åŸå§‹æ¥å£)
# ============================================================

def check_stage6_validation(snapshot_data: dict) -> tuple:
    """
    Stage 6 å°ˆç”¨é©—è­‰ - ç ”ç©¶æ•¸æ“šç”Ÿæˆèˆ‡å„ªåŒ–å±¤

    âš ï¸ å‘å¾Œå…¼å®¹å‡½æ•¸: å…§éƒ¨èª¿ç”¨ Stage6Validator é¡

    æª¢æŸ¥é …ç›®:
    - 5 é …å°ˆç”¨é©—è­‰æ¡†æ¶åŸ·è¡Œæƒ…æ³
    - 3GPP NTN äº‹ä»¶æª¢æ¸¬ (A4/A5/D2)
    - ML è¨“ç·´æ•¸æ“šç”Ÿæˆ
    - å‹•æ…‹æ± ç¶­æŒé©—è­‰
    - å¯¦æ™‚æ±ºç­–æ€§èƒ½

    Args:
        snapshot_data: é©—è­‰å¿«ç…§æ•¸æ“š

    Returns:
        tuple: (validation_passed: bool, message: str)
    """
    validator = Stage6Validator()
    return validator.validate(snapshot_data)
