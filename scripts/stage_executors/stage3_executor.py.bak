"""
Stage 3 åŸ·è¡Œå™¨ - åº§æ¨™ç³»çµ±è½‰æ›å±¤

é‡æ§‹ç‰ˆæœ¬ï¼šä½¿ç”¨ StageExecutor åŸºé¡ï¼Œæ¸›å°‘é‡è¤‡ä»£ç¢¼ã€‚
Phase 4 P1: é·ç§»è‡³ BaseConfigManager çµ±ä¸€é…ç½®ç®¡ç†

Author: Orbit Engine Refactoring Team
Date: 2025-10-12 (Refactored), 2025-10-15 (P1 Config Migration)
Version: 2.1 (Config Manager Integration)
"""

import sys
from typing import Dict, Any
from pathlib import Path

# Add src to Python path for imports
sys.path.insert(0, str(Path(__file__).resolve().parents[2] / 'src'))

from .base_executor import StageExecutor
from .executor_utils import project_root, is_sampling_mode
from stages.stage3_coordinate_transformation.stage3_config_manager import Stage3ConfigManager


class Stage3Executor(StageExecutor):
    """
    Stage 3 åŸ·è¡Œå™¨ - åº§æ¨™ç³»çµ±è½‰æ›å±¤ (v3.1)

    ç¹¼æ‰¿è‡ª StageExecutorï¼Œåªéœ€å¯¦ç¾é…ç½®åŠ è¼‰å’Œè™•ç†å™¨å‰µå»ºé‚è¼¯ã€‚
    åŒ…å«ç‰¹æ®Šçš„é…ç½®æ‰å¹³åŒ–é‚è¼¯ä»¥ä¿æŒå‘å¾Œå…¼å®¹æ€§ã€‚
    """

    def __init__(self):
        super().__init__(
            stage_number=3,
            stage_name="åº§æ¨™ç³»çµ±è½‰æ›å±¤ (v3.1 é‡æ§‹ç‰ˆæœ¬)",
            emoji="ğŸŒ"
        )

    def load_config(self) -> Dict[str, Any]:
        """
        è¼‰å…¥ Stage 3 é…ç½®

        ä½¿ç”¨ Stage3ConfigManager çµ±ä¸€é…ç½®ç®¡ç†ï¼š
        1. å¾ YAML æ–‡ä»¶è¼‰å…¥é…ç½®
        2. æ‡‰ç”¨ç’°å¢ƒè®Šæ•¸è¦†è“‹
        3. åŸ·è¡Œé…ç½®é©—è­‰
        4. æ‰å¹³åŒ–é…ç½®çµæ§‹ä»¥é©é…ç¾æœ‰è™•ç†å™¨æ¥å£

        Returns:
            Dict[str, Any]: æ‰å¹³åŒ–çš„é…ç½®å­—å…¸

        Raises:
            ValueError: é…ç½®é©—è­‰å¤±æ•—
        """
        # âœ… ä½¿ç”¨ Stage3ConfigManager çµ±ä¸€é…ç½®ç®¡ç†
        config_manager = Stage3ConfigManager()

        # å˜—è©¦ä½¿ç”¨æ–°é…ç½®æ–‡ä»¶åï¼Œå¦‚æœä¸å­˜åœ¨å‰‡å›é€€åˆ°èˆŠé…ç½®æ–‡ä»¶å
        new_config_path = project_root / "config/stage3_coordinate_transformation_config.yaml"
        old_config_path = project_root / "config/stage3_coordinate_transformation.yaml"

        if new_config_path.exists():
            stage3_config = config_manager.load_config(custom_path=new_config_path)
            print(f"âœ… å·²è¼‰å…¥ Stage 3 é…ç½®: {new_config_path}")
        elif old_config_path.exists():
            stage3_config = config_manager.load_config(custom_path=old_config_path)
            print(f"âœ… å·²è¼‰å…¥ Stage 3 é…ç½®: {old_config_path} (èˆŠé…ç½®æ–‡ä»¶ï¼Œå»ºè­°é·ç§»)")
        else:
            # ä½¿ç”¨é è¨­é…ç½®
            stage3_config = config_manager.load_config()
            print("âš ï¸ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨é è¨­é…ç½®")

        # âœ… å‘å¾Œå…¼å®¹ï¼šæ‰å¹³åŒ–é…ç½®çµæ§‹ (é©é…è™•ç†å™¨æ¥å£)
        config_compat = {
            'enable_geometric_prefilter': stage3_config.get('geometric_prefilter', {}).get('enabled', False),
            'coordinate_config': stage3_config.get('coordinate_config', {}),
            'precision_config': stage3_config.get('precision_config', {}),
            'cache_config': stage3_config.get('cache_config', {}),
            'parallel_config': stage3_config.get('parallel_config', {}),
            'iers_data': stage3_config.get('iers_data', {}),
            'reference_frames': stage3_config.get('reference_frames', {}),
            'output': stage3_config.get('output', {}),
            'validation': stage3_config.get('validation', {}),
            'performance': stage3_config.get('performance', {})
        }

        # âœ… æ ¹æ“šç’°å¢ƒè®Šé‡æ±ºå®šæ˜¯å¦ä½¿ç”¨å–æ¨£æ¨¡å¼ (å‘å¾Œå…¼å®¹)
        use_sampling = is_sampling_mode()
        if use_sampling:
            config_compat['sample_mode'] = True
            config_compat['sample_size'] = 50

        # é¡¯ç¤ºé…ç½®æ‘˜è¦
        print(f"ğŸ“‹ é…ç½®æ‘˜è¦:")
        print(f"   æºåº§æ¨™ç³»: {config_compat['coordinate_config'].get('source_frame', 'TEME')}")
        print(f"   ç›®æ¨™åº§æ¨™ç³»: {config_compat['coordinate_config'].get('target_frame', 'WGS84')}")
        print(f"   æ­²å·®ç« å‹•æ¨¡å‹: {config_compat['coordinate_config'].get('nutation_model', 'IAU2000A')}")
        print(f"   ç›®æ¨™ç²¾åº¦: {config_compat['precision_config'].get('target_accuracy_m', 0.5)}m")
        print(f"   å¹¾ä½•é ç¯©é¸: {'å•Ÿç”¨' if config_compat['enable_geometric_prefilter'] else 'ç¦ç”¨'}")
        print(f"   è™•ç†æ¨¡å¼: {'å–æ¨£æ¨¡å¼' if use_sampling else 'å®Œæ•´æ¨¡å¼'}")

        # Stage 3 ç‰¹åˆ¥æç¤ºï¼ˆè™•ç†æ™‚é–“è¼ƒé•·ï¼‰
        print('â±ï¸ Stage 3 åº§æ¨™è½‰æ›è™•ç†ä¸­ï¼Œé è¨ˆéœ€è¦ 5-15 åˆ†é˜...')

        return config_compat

    def create_processor(self, config: Dict[str, Any]):
        """
        å‰µå»º Stage 3 è™•ç†å™¨

        Args:
            config: load_config() è¿”å›çš„é…ç½®å­—å…¸

        Returns:
            Stage3CoordinateTransformProcessor: è™•ç†å™¨å¯¦ä¾‹
        """
        from stages.stage3_coordinate_transformation.stage3_coordinate_transform_processor import Stage3CoordinateTransformProcessor
        return Stage3CoordinateTransformProcessor(config=config)

    def get_previous_stage_number(self) -> int:
        """
        Stage 3 ä¾è³´ Stage 2 çš„çµæœ

        Returns:
            int: 2
        """
        return 2


# ===== å‘å¾Œå…¼å®¹å‡½æ•¸ =====

def execute_stage3(previous_results=None):
    """
    åŸ·è¡Œ Stage 3: åº§æ¨™ç³»çµ±è½‰æ›å±¤ (v3.1)

    å‘å¾Œå…¼å®¹å‡½æ•¸ï¼Œä¿æŒåŸæœ‰èª¿ç”¨æ–¹å¼ã€‚
    å…§éƒ¨ä½¿ç”¨ Stage3Executor é¡å¯¦ç¾ã€‚

    Args:
        previous_results: å‰åºéšæ®µçµæœå­—å…¸ï¼ˆå¿…é ˆåŒ…å« 'stage2' çµæœï¼‰

    Returns:
        tuple: (success: bool, result: ProcessingResult, processor: Stage3Processor)
    """
    executor = Stage3Executor()
    return executor.execute(previous_results)
