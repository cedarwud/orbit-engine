# Stage 4 鏈路可行性評估配置
# 符合計劃 A + 計劃 B 學術標準要求

# 學術標準模式 (計劃 B)
# 預先執行，精度優先，不考慮速度
use_iau_standards: true  # 使用 Skyfield IAU 標準計算器 (研究級精度)
validate_epochs: true     # 啟用 Epoch 驗證 (學術合規標準，Stage 3 現已傳遞 epoch_datetime)

# 階段 4.2 時空錯置池規劃優化 (NEW)
enable_pool_optimization: true  # 啟用時空錯置池規劃優化

# 星座特定門檻 (計劃 A)
# 註: 距離限制已移除，僅使用仰角門檻進行幾何篩選
# 原因: 仰角門檻已提供足夠的幾何約束（Starlink 5° → <2000km, OneWeb 10° → <1200km）
constellation_thresholds:
  starlink:
    elevation_deg: 5.0      # Starlink 最小仰角
    reason: "Starlink 官方規格"
  oneweb:
    elevation_deg: 10.0     # OneWeb 最小仰角
    reason: "OneWeb 官方規格"
  default:
    elevation_deg: 10.0     # 其他星座預設值

# 可見性計算方法
visibility:
  method: "skyfield_iau"    # skyfield_iau (IAU 標準) 或 manual_geometric (快速)
  coordinate_system: "WGS84 Ellipsoid"
  precision_level: "Research Grade"
  nutation_model: "IAU 2000A/2006"
  polar_motion_correction: true
  atmospheric_refraction: true  # Skyfield 自動處理

# NTPU 地面站座標
ground_station:
  name: "National Taipei University of Technology"
  latitude_deg: 24.9441
  longitude_deg: 121.3714
  altitude_m: 200.0

# Epoch 驗證設置 (計劃 B)
epoch_validation:
  enabled: true
  min_diversity_ratio: 0.5       # 要求至少 50% epoch 多樣性
  min_diversity_count: 3         # 或至少 3 個不同 epoch
  max_time_diff_days: 7          # 時間戳記與 epoch 最大差距 (天)
  min_distribution_hours: 24     # epoch 分布最小時間跨度 (小時)
  forbidden_fields:              # 禁止的統一時間基準字段
    - "calculation_base_time"
    - "primary_epoch_time"
    - "unified_time_base"

# 輸出格式 (計劃 A)
output:
  format: "complete_time_series_with_optimization"  # 完整時間序列 + 階段 4.2 優化
  version: "plan_a_b_integrated_v1.0"  # 計劃 A+B 整合版本 (含階段 4.2)
  include_time_series: true       # 包含完整時間序列
  include_service_window: true    # 包含服務窗口摘要
  include_is_connectable: true    # 包含每個時間點的 is_connectable 標記
  include_link_quality: true      # 包含鏈路品質估計
  include_epoch_report: true      # 包含 epoch 驗證報告
  include_optimization_metrics: true  # 包含階段 4.2 優化指標 (NEW)

# 日誌設置
logging:
  level: "INFO"
  enable_progress: true           # 顯示處理進度
  enable_epoch_validation: true   # 顯示 epoch 驗證詳情
  enable_iau_standard_info: true  # 顯示 IAU 標準信息

# 性能設置
performance:
  # 預先執行模式，不需要優化速度
  batch_size: null                # 無批次限制
  parallel_processing: true       # 🚨 測試: 啟用並行處理驗證精度影響
  max_workers: null               # null = 動態計算 (與 Stage 2/3 一致)
  memory_limit_mb: null           # 無記憶體限制

  # 動態 CPU 工作器策略（與 Stage 2 一致）
  dynamic_worker_strategy:
    cpu_usage_threshold_high: 30        # CPU < 30%: 使用 95% 核心（積極並行）
    cpu_usage_threshold_medium: 50      # CPU 30-50%: 使用 75% 核心
    # CPU > 50%: 使用 50% 核心（保守策略）

# 時間間隔設置 (Grade A 學術標準要求)
# 學術依據: Vallado 2013 Section 8.6 "SGP4 Propagation Time Step Recommendations"
# - 建議 SGP4 傳播間隔 < 1 分鐘以維持精度
# - 30秒間隔對應 LEO 衛星 ~225km 軌道移動，足夠捕捉可見性變化
time_interval_seconds: 30  # 必須明確提供 (禁止預設值)

# 階段 4.2 池優化目標配置 (Grade A+ 學術標準)
# SOURCE: 3GPP TR 38.821 (2021) Section 6.2 - NTN 系統服務品質要求
pool_optimization_targets:
  starlink:
    expected_visible_satellites: [10, 15]  # 預期可見衛星數範圍 [min, max]
    min_pool_size: 10              # 最小池大小（與 expected_visible_satellites[0] 一致）
    max_pool_size: 15              # 最大池大小（與 expected_visible_satellites[1] 一致）
    target_coverage_rate: 0.95
    # SOURCE: ITU-T E.800 (2008) - 研究原型系統可接受門檻
    # NOTE: 商用系統通常要求 >99% (3GPP TS 22.261 availability requirements)
  oneweb:
    expected_visible_satellites: [3, 6]    # 預期可見衛星數範圍 [min, max]
    min_pool_size: 3               # 最小池大小（與 expected_visible_satellites[0] 一致）
    max_pool_size: 6               # 最大池大小（與 expected_visible_satellites[1] 一致）
    target_coverage_rate: 0.95
    # SOURCE: ITU-T E.800 (2008) - 研究原型系統可接受門檻
    # NOTE: 商用系統通常要求 >99% (3GPP TS 22.261 availability requirements)

# 學術合規聲明
academic_compliance:
  iau_standards: true
  vallado_epoch_requirements: true
  kodheli_link_budget: true
  research_grade_precision: true
  peer_review_ready: true

# 引用文獻
references:
  - "Vallado, D. A. (2013). Fundamentals of Astrodynamics and Applications (4th ed.). Microcosm Press."
  - "Rhodes, B. (2019). Skyfield: High precision research-grade positions for planets and Earth satellites."
  - "Kodheli, O., et al. (2021). Satellite Communications in the New Space Era. IEEE Communications Surveys & Tutorials."
  - "IAU SOFA (2021). IAU Standards of Fundamental Astronomy."

# ==================== 環境變數覆寫支援 ====================
# 支援的環境變數 (由 BaseConfigManager 自動處理):
#
# 頂層鍵 (Top-level keys):
# - ORBIT_ENGINE_STAGE4_USE_IAU_STANDARDS: 覆寫 use_iau_standards
# - ORBIT_ENGINE_STAGE4_VALIDATE_EPOCHS: 覆寫 validate_epochs
# - ORBIT_ENGINE_STAGE4_ENABLE_POOL_OPTIMIZATION: 覆寫 enable_pool_optimization
# - ORBIT_ENGINE_STAGE4_TIME_INTERVAL_SECONDS: 覆寫 time_interval_seconds
#
# 嵌套鍵 (Nested keys) - 使用三重下劃線 (___) 分隔層級:
# - ORBIT_ENGINE_STAGE4_CONSTELLATION_THRESHOLDS___STARLINK___ELEVATION_DEG: 覆寫 constellation_thresholds.starlink.elevation_deg
# - ORBIT_ENGINE_STAGE4_CONSTELLATION_THRESHOLDS___ONEWEB___ELEVATION_DEG: 覆寫 constellation_thresholds.oneweb.elevation_deg
# - ORBIT_ENGINE_STAGE4_POOL_OPTIMIZATION_TARGETS___STARLINK___MIN_POOL_SIZE: 覆寫 pool_optimization_targets.starlink.min_pool_size
# - ORBIT_ENGINE_STAGE4_POOL_OPTIMIZATION_TARGETS___STARLINK___TARGET_COVERAGE_RATE: 覆寫 pool_optimization_targets.starlink.target_coverage_rate
# - ORBIT_ENGINE_STAGE4_POOL_OPTIMIZATION_TARGETS___ONEWEB___TARGET_COVERAGE_RATE: 覆寫 pool_optimization_targets.oneweb.target_coverage_rate
# - ORBIT_ENGINE_STAGE4_PERFORMANCE___MAX_WORKERS: 覆寫 performance.max_workers
# - ORBIT_ENGINE_STAGE4_PERFORMANCE___PARALLEL_PROCESSING: 覆寫 performance.parallel_processing
# - ORBIT_ENGINE_STAGE4_EPOCH_VALIDATION___MIN_DIVERSITY_RATIO: 覆寫 epoch_validation.min_diversity_ratio
# - ORBIT_ENGINE_STAGE4_LOGGING___LEVEL: 覆寫 logging.level
#
# 範例:
#   # 單個覆寫 - 測試不同仰角門檻
#   export ORBIT_ENGINE_STAGE4_CONSTELLATION_THRESHOLDS___STARLINK___ELEVATION_DEG=10.0
#   ./run.sh --stage 4
#
#   # 多個覆寫 - 池優化實驗
#   export ORBIT_ENGINE_STAGE4_POOL_OPTIMIZATION_TARGETS___STARLINK___MIN_POOL_SIZE=12
#   export ORBIT_ENGINE_STAGE4_POOL_OPTIMIZATION_TARGETS___STARLINK___MAX_POOL_SIZE=18
#   export ORBIT_ENGINE_STAGE4_POOL_OPTIMIZATION_TARGETS___STARLINK___TARGET_COVERAGE_RATE=0.98
#   ./run.sh --stage 4
#
#   # 調試模式
#   export ORBIT_ENGINE_STAGE4_LOGGING___LEVEL="DEBUG"
#   export ORBIT_ENGINE_STAGE4_PERFORMANCE___MAX_WORKERS=8
#   ./run.sh --stage 4