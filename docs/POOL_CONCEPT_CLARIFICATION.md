# 動態衛星池概念澄清與架構調整

**文檔日期**: 2025-09-30 (最後更新: 同日)
**調整原因**: 用戶質疑發現文檔與代碼不同步，池概念描述不清晰
**調整範圍**: final.md, stage4-link-feasibility.md, stage5-signal-analysis.md, stage6-research-optimization.md, STAGES_OVERVIEW.md
**參考來源**: th.md 改進建議 (使用者提供的文檔檢查結果)

---

## 🎯 問題根源

### 原始誤解
**錯誤概念**: 以為「候選衛星總數」= 「任意時刻可見數」

```
❌ 錯誤理解：
"Stage 4 輸出 1845 顆 Starlink 候選"
→ 誤以為達成了「10-15顆可見」目標

✅ 正確理解：
"整個軌道週期內，有 1845 顆衛星曾經經過 NTPU"
→ 但任意時刻只有 10-15 顆同時可見
→ 需要從 1845 顆中優化選擇 500 顆，確保任意時刻 10-15 顆可見
```

### 架構缺失
當前 Stage 4 **只實現了可見性篩選**，**沒有實現池規劃優化**

---

## 📊 調整後的正確架構

### 六階段數據流（修正版）

```
Stage 1: TLE 數據載入
  └─ 9,040 顆衛星（Starlink 8389 + OneWeb 651）

Stage 2: 軌道狀態傳播
  └─ 9,040 顆 × ~200 時間點 ≈ 860,957 軌道點（TEME）

Stage 3: 座標系統轉換
  └─ 9,040 顆 WGS84 座標

Stage 4: 鏈路可行性評估與池規劃層 ⚠️ 關鍵修正
  ├─ 4.1 可見性篩選 (已實現)
  │   └─ ~2,000 顆候選（整個週期內曾經可見）
  │       └─ 估算: Starlink ~1,800, OneWeb ~200
  │
  └─ 4.2 時空錯置池規劃 ⚠️ (規劃中，代碼待實現)
      └─ ~600 顆最優池（確保任意時刻目標數量可見）
          └─ 估算: Starlink ~500, OneWeb ~100

Stage 5: 信號品質分析
  └─ 對 ~600 顆最優池進行 3GPP 信號計算

Stage 6: 研究數據生成
  ├─ 池維持驗證（逐時間點驗證）
  ├─ 3GPP 事件生成（A4/A5/D2）
  └─ ML 訓練數據生成
```

---

## 🔧 Stage 4 兩階段設計

### 階段 4.1: 可見性篩選（已實現）

**輸入**: 9,040 顆衛星（WGS84 座標）

**處理**:
1. 計算每顆衛星的仰角、方位角、距離
2. 應用星座特定門檻
   - Starlink: ≥5° 仰角
   - OneWeb: ≥10° 仰角
3. 應用鏈路預算約束
   - 距離範圍: 200-2000km
4. 標記每個時間點的 `is_connectable` 狀態

**輸出**: ~2,000 顆候選衛星（含完整時間序列）

**實現狀態**: ✅ 已完整實現

---

### 階段 4.2: 時空錯置池規劃（規劃中）

**輸入**: ~2,000 顆候選衛星（來自階段 4.1）

**目標**: 從 2,000 顆中優化選擇 ~600 顆，確保：
- Starlink: 任意時刻 10-15 顆同時可見
- OneWeb: 任意時刻 3-6 顆同時可見
- 覆蓋率: ≥95% 時間點達標

**優化方法**（待設計）:
- **選項 A**: 貪心算法（快速，次優解）
- **選項 B**: 遺傳算法（較慢，較優解）
- **選項 C**: 整數規劃（精確，計算密集）

**輸出**: ~500 顆 Starlink + ~100 顆 OneWeb 最優池

**實現狀態**: ⚠️ 規劃階段，代碼待開發

---

## 📝 已更新的文檔

### 1. `docs/final.md`
- ✅ 增加階段性篩選流程說明
- ✅ 明確標註估算值和實現狀態
- ✅ 添加「Stage 4.2 待實現」警告

### 2. `docs/stages/stage4-link-feasibility.md`
- ✅ 更新為「兩階段處理架構」
- ✅ 分別描述 4.1 (已實現) 和 4.2 (規劃中)
- ✅ 添加架構圖展示兩階段關係
- ✅ 更新性能指標，區分兩階段估算
- ✅ 所有數字標註為「估算值，待實測」

### 3. `docs/stages/stage5-signal-analysis.md`
- ✅ 加入時間序列處理說明
- ✅ 明確「遍歷每顆衛星的時間序列，逐時間點計算信號品質」
- ✅ 更新輸出格式為時間序列數組

### 4. `docs/stages/stage6-research-optimization.md`
- ✅ 修正池維持驗證邏輯
- ✅ 從錯誤的「候選總數檢查」改為「逐時間點驗證」
- ✅ 提供完整的 `verify_pool_maintenance()` 函數範例
- ✅ 在文檔開頭加入「❌ 錯誤 vs ✅ 正確」範例對比

### 5. `docs/stages/STAGES_OVERVIEW.md`
- ✅ 更新 Stage 4 描述為「兩階段處理」
- ✅ 明確標註估算數字和實現狀態
- ✅ 加入時間序列處理說明（Stage 5）
- ✅ 更新池驗證職責說明（Stage 6）

---

## ⚠️ 估算數字說明

### 當前使用的估算值

| 階段 | 輸入 | 輸出 | 狀態 |
|------|------|------|------|
| Stage 3 | 9,040 | 9,040 (WGS84) | ✅ 實際 |
| Stage 4.1 | 9,040 | ~2,000 候選 | ⚠️ 估算 |
| Stage 4.2 | ~2,000 | ~600 最優池 | ⚠️ 估算 |
| Stage 5 | ~600 | ~600 (含信號) | ⚠️ 估算 |

### 估算依據
1. **~2,000 候選**: 基於 Starlink/OneWeb 軌道覆蓋特性的理論估算
2. **~500 Starlink**: 基於 final.md 需求「任意時刻 10-15 顆可見」的反推
3. **~100 OneWeb**: 基於 final.md 需求「任意時刻 3-6 顆可見」的反推

### 驗證計劃
實際數字將通過以下步驟確認：
1. 運行 Stage 1-4.1，查看實際候選數量
2. 檢查任意時刻實際可見數量
3. 根據實測數據調整 Stage 4.2 優化策略
4. 更新所有文檔中的估算值

---

## 🚀 後續行動計劃

### 立即行動（文檔已完成）
- [x] 更新 final.md 添加估算說明
- [x] 更新 stage4-link-feasibility.md 兩階段架構
- [x] 更新 stage6-research-optimization.md 驗證邏輯
- [x] 更新 STAGES_OVERVIEW.md 概述

### 近期計劃（代碼開發）
- [ ] 運行 Stage 1-4.1，獲取實際候選數量
- [ ] 分析任意時刻實際可見衛星數
- [ ] 根據實測結果，設計 Stage 4.2 優化算法
- [ ] 實現 Stage 4.2 池規劃代碼
- [ ] 更新所有估算數字為實測值

---

## 📌 關鍵概念總結

### ✅ 正確理解「動態衛星池」

**定義**: 通過數百顆候選衛星的時空錯置軌道運行，確保 NTPU 上空任意時刻都維持指定數量衛星可見的動態覆蓋系統。

**關鍵點**:
1. **候選衛星總數** ≠ **任意時刻可見數**
2. **2,000 顆候選** = 整個軌道週期內「曾經可見」的衛星集合
3. **500 顆最優池** = 經過優化選擇，確保「任意時刻目標數量可見」的子集
4. **10-15 顆可見** = 在某個特定時間點 t，實際同時可見的衛星數量

### ❌ 常見誤解

| 誤解 | 正確理解 |
|------|---------|
| "有 2000 顆候選就達標了" | 需要從 2000 顆中優化選擇約 500 顆 |
| "候選數量 = 可見數量" | 候選數量是週期總數，可見數量是瞬時數量 |
| "Stage 4 已經完成池規劃" | Stage 4 只完成了可見性篩選，池規劃待實現 |
| "1845 顆太多了" | 正確！需要 Stage 4.2 進一步優化到 ~500 顆 |

---

**文檔版本**: v1.0
**最後更新**: 2025-09-30
**作者**: Claude Code (基於用戶質疑的架構修正)