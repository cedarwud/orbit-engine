# Stage 1 規格解讀指南

## 📚 目的

本文檔旨在防止對 Stage 1 規格文檔和驗證邏輯的誤解，明確區分不同層面的約束規則。

---

## 🎯 核心概念：三個層面的區分

### 1️⃣ **數據層面**（Data Layer）
處理輸入/輸出數據，必須使用真實數據源。

**零容忍規則適用**：
- ❌ 禁止估算衛星軌道參數（如高度、速度）
- ❌ 禁止使用模擬/隨機數據（`np.random()`）
- ❌ 禁止估算或替換 TLE epoch 時間

**範例**：
```python
# ❌ 違反零容忍（數據層面）
satellite_altitude = 550  # 估算 Starlink 高度
epoch = datetime.now()    # 用當前時間替代 TLE epoch
```

---

### 2️⃣ **算法層面**（Algorithm Layer）
實現物理/數學計算，必須使用官方標準算法。

**零容忍規則適用**：
- ❌ 禁止簡化算法（如用簡化公式替代 SGP4）
- ❌ 禁止估算物理常數（必須使用 CODATA 2018）
- ❌ 禁止使用近似值（如 π=3.14）

**範例**：
```python
# ❌ 違反零容忍（算法層面）
# 用簡化公式替代官方算法
orbital_period = 2 * pi * sqrt(a**3 / GM)  # 應用 SGP4

# ❌ 估算物理常數
speed_of_light = 300000  # 應用 299792458 (CODATA 2018)
```

---

### 3️⃣ **品質控制層面**（Quality Control Layer）
驗證和測試邏輯，允許工程判斷。

**零容忍規則不適用**：
- ✅ 允許設定品質閾值（如 95% 數據完整度）
- ✅ 允許選擇驗證樣本量（如 20 顆異常檢測）
- ✅ 允許設定超時時間（如 30 秒 API 超時）
- ✅ 允許定義錯誤容忍度（如 5% 更新延遲）

**範例**：
```python
# ✅ 允許（品質控制層面）
min_data_completeness = 0.95  # 95% 完整度標準
sample_size = 20              # 異常檢測樣本量
api_timeout = 30              # API 請求超時（秒）
```

---

## 🔍 關鍵判斷標準

當你看到一個數值/參數時，問自己：

| 問題 | 如果是「數據/算法」 | 如果是「品質控制」 |
|-----|-----------------|--------------|
| **這個值影響什麼？** | 影響物理計算結果 | 影響驗證通過/失敗 |
| **這個值來自哪裡？** | 應來自官方標準 | 可來自工程經驗 |
| **如果改變會怎樣？** | 結果不符合物理 | 驗證標準寬鬆/嚴格 |
| **是否需要學術依據？** | ✅ 必須 | ❌ 不必（但需註釋） |

---

## 📊 實際案例分析

### **案例 1: 95% 數據完整度閾值**

```python
min_acceptable = int(expected_total * 0.95)
```

**判斷**：
- ❓ 這是什麼層面？→ **品質控制層面**
- ❓ 影響物理計算嗎？→ ❌ 否（只影響驗證通過/失敗）
- ❓ 需要官方標準嗎？→ ❌ 否（但需註釋理由）
- ✅ **結論**：不違反零容忍規則，屬於工程判斷

---

### **案例 2: 20 顆驗證樣本**

```python
sample_size = 20  # 異常檢測樣本量
```

**判斷**：
- ❓ 這是什麼層面？→ **品質控制層面**
- ❓ 這是統計推論嗎？→ ❌ 否（是異常檢測）
- ❓ 目的是什麼？→ 檢測系統性錯誤（如所有 TLE 都空字串）
- ✅ **結論**：不違反零容忍規則，20 顆足以檢測系統性問題

**統計學說明**：
- **異常檢測**：檢查是否有系統性問題（需要 20-50 顆）
- **統計推論**：估計總體錯誤率（需要 370 顆）
- 我們的場景是前者，不是後者

---

### **案例 3: 5 個 unique epochs 閾值**

```python
min_unique_epochs = 5  # 25% 多樣性
```

**判斷**：
- ❓ 這是什麼層面？→ **品質控制層面**
- ❓ 是估算 epoch 時間嗎？→ ❌ 否（是檢查已有 epoch 的多樣性）
- ❓ 基於什麼？→ 真實數據分析（20 顆樣本中實測有 17 個 unique epochs）
- ✅ **結論**：不違反零容忍規則，基於真實數據分析

---

## ⚠️ 常見誤解清單

### **誤解 1**：「所有估算值都禁止」

❌ **錯誤理解**：
> 因為「零容忍」規則說「禁止估算值」，所以 95% 閾值也是估算值，違反規則。

✅ **正確理解**：
> 「禁止估算值」僅適用於數據和算法層面（如估算衛星高度），不適用於品質閾值。

---

### **誤解 2**：「20 顆樣本不足，需要 370 顆」

❌ **錯誤理解**：
> 統計學公式計算出需要 370 顆樣本（95% 信賴區間），所以 20 顆不夠。

✅ **正確理解**：
> 370 顆適用於「統計推論」（估計錯誤率），我們的目的是「異常檢測」（檢測系統性錯誤），20 顆充足。

**類比**：
- ❌ 錯誤類比：「從 9040 顆蘋果中抽 370 顆，估計總體腐爛率」
- ✅ 正確類比：「從 9040 顆蘋果中抽 20 顆，檢查是否整批都是橘子（系統性錯誤）」

---

### **誤解 3**：「品質閾值需要學術論文支持」

❌ **錯誤理解**：
> Grade A 學術標準要求所有參數都有學術依據，所以 95% 需要引用論文。

✅ **正確理解**：
> Grade A 標準僅約束數據來源和算法（如 SGP4、ITU-R），不約束驗證閾值。

**文檔說明**（stage1-specification.md:725-726）：
```markdown
⚠️ 適用範圍說明：
以下規則僅適用於數據處理和算法實現，不適用於品質控制和驗證邏輯。
```

---

## 📝 最佳實踐建議

### **對文檔撰寫者**：

1. ✅ **明確適用範圍**
   ```markdown
   ### 零容忍項目（數據處理與算法層面）  ← 加上範圍說明
   ```

2. ✅ **提供正反範例**
   ```python
   # ❌ 禁止：估算數據值
   satellite_altitude = 550

   # ✅ 允許：品質閾值
   min_data_completeness = 0.95
   ```

3. ✅ **區分不同層面**
   - 數據層面的禁止項目
   - 算法層面的禁止項目
   - 品質控制層面的允許項目

---

### **對程式碼撰寫者**：

1. ✅ **添加詳細註釋**
   ```python
   # 95% 完整度標準
   # 理由：
   # 1. Space-Track.org 每日更新，允許正常延遲
   # 2. 符合軟體工程常見標準（如測試覆蓋率）
   # 3. 實測歷史數據完整度 >99%（保守估計）
   min_acceptable = int(expected_total * 0.95)
   ```

2. ✅ **說明目的和性質**
   ```python
   # 樣本量說明（20顆）：
   # 目的：異常檢測（非統計推論）
   # 範例：檢查是否所有TLE都是空字串
   sample_size = 20
   ```

3. ✅ **基於真實數據分析**
   ```python
   # 基於真實數據分析（2025-09-30實測）：
   # - 20顆樣本中有 17 個 unique epochs（85%）
   # 閾值選擇：5 個（25%，P10分位數）
   min_unique_epochs = 5
   ```

---

### **對程式碼審查者**：

1. ✅ **先判斷層面**
   - 看到一個參數/閾值，先判斷它屬於哪個層面
   - 數據/算法層面 → 嚴格審查，要求官方標準
   - 品質控制層面 → 檢查是否有合理註釋

2. ✅ **檢查註釋完整性**
   - 品質閾值應該有註釋說明理由
   - 樣本量應該說明目的（異常檢測 vs 統計推論）
   - 基於數據分析的閾值應該引用實測結果

3. ✅ **避免過度解讀規則**
   - 不要把「數據層面」的規則套用到「品質控制層面」
   - 不要混淆「異常檢測」和「統計推論」
   - 不要要求所有數字都需要學術論文支持

---

## 🎯 快速檢查表

當你審查代碼或文檔時，使用這個檢查表：

### **看到一個數值參數時**：

- [ ] 這個參數用於物理計算嗎？（數據/算法層面）
  - 如果是 → 檢查是否來自官方標準
  - 如果否 → 繼續下一步

- [ ] 這個參數用於驗證邏輯嗎？（品質控制層面）
  - 如果是 → 檢查是否有註釋說明理由
  - 如果否 → 確認其用途

- [ ] 這個參數是否影響物理正確性？
  - 如果是 → 必須有學術依據
  - 如果否 → 工程判斷即可（但需註釋）

---

## 📚 延伸閱讀

- `docs/stages/stage1-specification.md` - Stage 1 完整規格
- `scripts/run_six_stages_with_validation.py` - 驗證邏輯實現
- `.claude/CLAUDE.md` - SuperClaude 開發原則

---

**文檔版本**: v1.0
**最後更新**: 2025-10-01
**維護者**: Orbit Engine Team
