# GitHub Actions - å­¸è¡“åˆè¦æ€§è‡ªå‹•æª¢æŸ¥
#
# è§¸ç™¼æ¢ä»¶:
#   - æ¯æ¬¡ push
#   - æ¯æ¬¡ pull request
#
# åŠŸèƒ½:
#   - è‡ªå‹•é‹è¡Œå­¸è¡“åˆè¦æ€§æª¢æŸ¥
#   - ç™¼ç¾ CRITICAL é•è¦æ™‚é˜»æ­¢åˆä½µ
#   - ç”Ÿæˆè©³ç´°å ±å‘Š

name: Academic Compliance Check

on:
  push:
    branches: [ main, develop, stage-* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  compliance-check:
    name: å­¸è¡“åˆè¦æ€§æª¢æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»£ç¢¼
        uses: actions/checkout@v3

      - name: è¨­ç½® Python ç’°å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: å®‰è£ä¾è³´
        run: |
          pip install pytest pylint

      - name: é‹è¡Œå­¸è¡“åˆè¦æ€§æª¢æŸ¥
        id: compliance
        run: |
          python tools/academic_compliance_checker.py src/ | tee compliance_report.txt
          exit_code=${PIPESTATUS[0]}
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code
        continue-on-error: true

      - name: ä¸Šå‚³æª¢æŸ¥å ±å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: compliance-report
          path: compliance_report.txt

      - name: è©•è«– PR (å¦‚æœæœ‰é•è¦)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('compliance_report.txt', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ å­¸è¡“åˆè¦æ€§æª¢æŸ¥å¤±æ•—\n\n\`\`\`\n${report}\n\`\`\`\n\nğŸ”§ è«‹åƒè€ƒ [å­¸è¡“åˆè¦æ€§é–‹ç™¼æŒ‡å—](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/ACADEMIC_COMPLIANCE_GUIDE.md) ä¿®æ­£é•è¦é …ç›®ã€‚`
            });

      - name: æª¢æŸ¥çµæœ
        if: steps.compliance.outputs.exit_code != '0'
        run: |
          echo "::error::ç™¼ç¾å­¸è¡“åˆè¦æ€§é•è¦ï¼Œè«‹ä¿®æ­£å¾Œå†æäº¤"
          exit 1

      - name: æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… å­¸è¡“åˆè¦æ€§æª¢æŸ¥é€šé"
