# ğŸ› ï¸ Orbit Engine é–‹ç™¼æ¨¡å¼ Docker Compose é…ç½®
# ç”¨æ–¼é–‹ç™¼æ™‚çš„å®¹å™¨é…ç½®ï¼Œæ”¯æ´ç†±é‡è¼‰å’Œå³æ™‚èª¿è©¦
# çµ±ä¸€ä½¿ç”¨ orbit-engine è·¯å¾‘å‘½åè¦ç¯„

services:
  orbit-engine-dev:
    build:
      context: .
      dockerfile: Dockerfile
    image: orbit-engine-dev
    container_name: orbit-engine-dev
    user: "1010:1010"  # æ˜ å°„åˆ°ä¸»æ©Ÿ sat ç”¨æˆ¶

    # ğŸš€ GPU æ”¯æ´é…ç½® (RTX 4090) - å·²å•Ÿç”¨
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    # ğŸ”„ é–‹ç™¼æ¨¡å¼ Volume æ›è¼‰ - Orbit Engine çµ±ä¸€è·¯å¾‘
    volumes:
      # ğŸ“ æºç¢¼ç†±é‡è¼‰æ›è¼‰
      - ./src:/orbit-engine/src                                  # å…­éšæ®µæ ¸å¿ƒä»£ç¢¼
      - ./config:/orbit-engine/config                            # é…ç½®æ–‡ä»¶
      - ./scripts:/orbit-engine/scripts                          # åŸ·è¡Œè…³æœ¬
      - ./tests:/orbit-engine/tests                              # æ¸¬è©¦æ–‡ä»¶

      # ğŸ“Š é–‹ç™¼æ•¸æ“šæ›è¼‰ - çµ±ä¸€ orbit-engine è·¯å¾‘
      - ./data/tle_data:/orbit-engine/data/tle_data              # TLE æ­·å²æ•¸æ“š
      - ./data/outputs:/orbit-engine/data/outputs                # é€šç”¨è¼¸å‡ºç›®éŒ„
      - ./data/outputs/stage1:/orbit-engine/data/outputs/stage1  # éšæ®µä¸€è¼¸å‡º (çµ±ä¸€è·¯å¾‘)
      - ./data/outputs/stage2:/orbit-engine/data/outputs/stage2  # éšæ®µäºŒè¼¸å‡º (çµ±ä¸€è·¯å¾‘)
      - ./data/outputs/stage3:/orbit-engine/data/outputs/stage3  # éšæ®µä¸‰è¼¸å‡º (çµ±ä¸€è·¯å¾‘)
      - ./data/outputs/stage4:/orbit-engine/data/outputs/stage4  # éšæ®µå››è¼¸å‡º (çµ±ä¸€è·¯å¾‘)
      - ./data/outputs/stage5:/orbit-engine/data/outputs/stage5  # éšæ®µäº”è¼¸å‡º (çµ±ä¸€è·¯å¾‘)
      - ./data/outputs/stage6:/orbit-engine/data/outputs/stage6  # éšæ®µå…­è¼¸å‡º (çµ±ä¸€è·¯å¾‘)
      - ./data/validation_snapshots:/orbit-engine/data/validation_snapshots  # é©—è­‰å¿«ç…§
      - ./data/logs:/orbit-engine/data/logs                      # é–‹ç™¼æ—¥èªŒ

      # ğŸ› ï¸ é–‹ç™¼å·¥å…·
      - ./docs:/orbit-engine/docs                                # æ–‡æª”ç›®éŒ„
      - ./.env.orbit-engine:/orbit-engine/.env                   # ç’°å¢ƒè®Šé‡æ–‡ä»¶ (çµ±ä¸€é…ç½®)

    # ğŸŒ é–‹ç™¼ç’°å¢ƒè®Šé‡ - Orbit Engine é…ç½®
    environment:
      # ğŸš€ æ ¸å¿ƒè·¯å¾‘é…ç½®
      - ORBIT_ENGINE_NAME=orbit-engine
      - PROJECT_ROOT_NAME=orbit-engine-system
      - CONTAINER_ROOT=/orbit-engine
      - PYTHONPATH=/orbit-engine/src

      # ğŸ“‚ æ•¸æ“šè·¯å¾‘é…ç½®
      - CONTAINER_DATA_ROOT=/orbit-engine/data
      - CONTAINER_OUTPUTS_ROOT=/orbit-engine/data/outputs
      - CONTAINER_TLE_DATA=/orbit-engine/data/tle_data
      - CONTAINER_VALIDATION_SNAPSHOTS=/orbit-engine/data/validation_snapshots
      - CONTAINER_LOGS=/orbit-engine/data/logs

      # ğŸ“Š éšæ®µè¼¸å‡ºè·¯å¾‘
      - CONTAINER_STAGE1_OUTPUT=/orbit-engine/data/outputs/stage1
      - CONTAINER_STAGE2_OUTPUT=/orbit-engine/data/outputs/stage2
      - CONTAINER_STAGE3_OUTPUT=/orbit-engine/data/outputs/stage3
      - CONTAINER_STAGE4_OUTPUT=/orbit-engine/data/outputs/stage4
      - CONTAINER_STAGE5_OUTPUT=/orbit-engine/data/outputs/stage5
      - CONTAINER_STAGE6_OUTPUT=/orbit-engine/data/outputs/stage6

      # ğŸ”§ é–‹ç™¼é…ç½®
      - SATELLITE_ENV=development
      - VALIDATION_LEVEL=FAST
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - RELOAD_ON_CHANGE=true

      # ğŸš€ GPU æ”¯æ´ç’°å¢ƒè®Šé‡
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility

      # ğŸ“Š PostgreSQL é…ç½®
      - POSTGRES_HOST=orbit-postgres-dev
      - POSTGRES_PORT=5432
      - POSTGRES_DB=orbit_engine_dev
      - POSTGRES_USER=orbit_engine_user
      - POSTGRES_PASSWORD=orbit_engine_dev_pass
      - DATABASE_URL=postgresql://orbit_engine_user:orbit_engine_dev_pass@orbit-postgres-dev:5432/orbit_engine_dev

    # ğŸ”Œ ç«¯å£æ˜ å°„
    ports:
      - "8900:8900"   # å¥åº·æª¢æŸ¥ç«¯é»
      - "8901:8901"   # é–‹ç™¼ API ç«¯é»
      - "5678:5678"   # Python èª¿è©¦ç«¯å£

    # ğŸƒ é–‹ç™¼æ¨¡å¼å‘½ä»¤ (ä¿æŒå®¹å™¨é‹è¡Œ)
    command: >
      sh -c "
        echo 'ğŸš€ Orbit Engine é–‹ç™¼æ¨¡å¼å•Ÿå‹•...'
        echo 'ğŸ“‚ æºç¢¼ç›®éŒ„: /orbit-engine/src'
        echo 'ğŸ“Š æ•¸æ“šç›®éŒ„: /orbit-engine/data'
        echo 'âš¡ ä½¿ç”¨ FAST é©—è­‰æ¨¡å¼'

        # æª¢æŸ¥å¥åº·ç‹€æ…‹
        python /orbit-engine/scripts/health_check.py

        # ä¿æŒå®¹å™¨é‹è¡Œï¼Œç­‰å¾…æ‰‹å‹•åŸ·è¡Œ
        echo 'âœ… Orbit Engine å®¹å™¨å°±ç·’ï¼Œå¯ä»¥åŸ·è¡Œè™•ç†ä»»å‹™'
        echo 'ğŸ’¡ åŸ·è¡Œå‘½ä»¤: docker exec orbit-engine-dev python /orbit-engine/scripts/run_six_stages_with_validation.py'

        tail -f /dev/null
      "

    # ğŸ”„ é–‹ç™¼é‡å•Ÿç­–ç•¥
    restart: unless-stopped

    # ğŸ“‹ ä¾è³´æœå‹™
    depends_on:
      - orbit-postgres-dev

    # ğŸŒ é–‹ç™¼ç¶²è·¯
    networks:
      - orbit-engine-dev-network

    # ğŸ·ï¸ é–‹ç™¼æ¨™ç±¤
    labels:
      - "orbit-engine.env=development"
      - "orbit-engine.auto-reload=true"

  # ğŸ“Š é–‹ç™¼ç”¨ PostgreSQL
  orbit-postgres-dev:
    image: postgres:15
    container_name: orbit-postgres-dev
    environment:
      - POSTGRES_DB=orbit_engine_dev
      - POSTGRES_USER=orbit_engine_user
      - POSTGRES_PASSWORD=orbit_engine_dev_pass
    volumes:
      - orbit-postgres-dev-data:/var/lib/postgresql/data
      - ./sql:/docker-entrypoint-initdb.d              # é–‹ç™¼ç”¨ SQL è…³æœ¬
    ports:
      - "5433:5432"  # é¿å…èˆ‡ä¸»æ©Ÿ PostgreSQL è¡çª
    networks:
      - orbit-engine-dev-network
    restart: unless-stopped

  # ğŸ“ˆ é–‹ç™¼ç›£æ§å·¥å…·
  orbit-dev-monitor:
    image: alpine:latest
    container_name: orbit-dev-monitor
    command: >
      sh -c "
        echo 'ğŸ“Š Orbit Engine é–‹ç™¼ç›£æ§å•Ÿå‹•...'
        while true; do
          echo '=== $(date) ==='
          echo 'ğŸ“‚ è¼¸å‡ºç›®éŒ„:'
          ls -la /data/outputs/ 2>/dev/null || echo '  (ç©º)'
          echo 'ğŸ” é©—è­‰å¿«ç…§:'
          ls -la /data/validation/ 2>/dev/null || echo '  (ç©º)'
          echo 'ğŸ“ æœ€æ–°æ—¥èªŒ:'
          tail -n 3 /data/logs/*.log 2>/dev/null || echo '  (ç„¡æ—¥èªŒ)'
          echo '================================='
          sleep 30
        done
      "
    volumes:
      - ./data/outputs:/data/outputs:ro
      - ./data/validation_snapshots:/data/validation_snapshots:ro
      - ./data/logs:/data/logs:ro
    networks:
      - orbit-engine-dev-network
    restart: unless-stopped

# ğŸ’¾ é–‹ç™¼æ•¸æ“šå·
volumes:
  orbit-postgres-dev-data:
    driver: local

# ğŸŒ é–‹ç™¼ç¶²è·¯
networks:
  orbit-engine-dev-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.32.0.0/16