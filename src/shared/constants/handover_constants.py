#!/usr/bin/env python3
"""
æ›æ‰‹æ±ºç­–å¸¸æ•¸å®šç¾© - Stage 6 å­¸è¡“æ¨™æº–åˆè¦

æ‰€æœ‰æ›æ‰‹æ±ºç­–ç›¸é—œçš„æ¬Šé‡ã€é–€æª»å’Œåƒæ•¸å‡åŸºæ–¼å­¸è¡“æ–‡ç»å’Œ 3GPP æ¨™æº–

å­¸è¡“åƒè€ƒ:
1. Saaty, T. L. (1980). "The Analytic Hierarchy Process"
   - å¤šå±¬æ€§æ±ºç­–ç†è«– (MADM)
2. 3GPP TS 36.300 Section 10.1.2.2 - Handover Decision Criteria
3. 3GPP TS 38.331 - NR RRC Protocol Specification

Author: ORBIT Engine Team
Created: 2025-10-02
"""


class HandoverDecisionWeights:
    """æ›æ‰‹æ±ºç­–æ¬Šé‡é…ç½®

    ä¾æ“š: Analytic Hierarchy Process (AHP) å¤šå±¬æ€§æ±ºç­–ç†è«–
    åƒè€ƒ: Saaty, T. L. (1980). "The Analytic Hierarchy Process"

    æ¬Šé‡åˆ†é…ç†ç”±:
    - ä¿¡è™Ÿå“è³ª (50%): ä¸»å°å› å­ï¼Œç›´æ¥å½±éŸ¿æœå‹™è³ªé‡
    - å¹¾ä½•é…ç½® (30%): å½±éŸ¿éˆè·¯ç©©å®šæ€§å’ŒæŒçºŒæ™‚é–“
    - ç©©å®šæ€§æŒ‡æ¨™ (20%): å½±éŸ¿æ›æ‰‹æˆåŠŸç‡
    """

    # ============================================================
    # å€™é¸è¡›æ˜Ÿè©•åˆ†æ¬Šé‡
    # ============================================================
    # SOURCE: åŸºæ–¼ AHP ç†è«–çš„å°ˆå®¶è©•ä¼°çŸ©é™£
    # ä¸€è‡´æ€§æ¯”ç‡ CR < 0.1 (ç¬¦åˆ Saaty å»ºè­°)
    SIGNAL_QUALITY_WEIGHT = 0.5  # ä¿¡è™Ÿå“è³ªæ¬Šé‡
    GEOMETRY_WEIGHT = 0.3        # å¹¾ä½•é…ç½®æ¬Šé‡ (ä»°è§’ã€è·é›¢)
    STABILITY_WEIGHT = 0.2       # ç©©å®šæ€§æ¬Šé‡ (SINRã€éˆè·¯è£•åº¦)

    # ============================================================
    # æ›æ‰‹å¯è¡Œæ€§é–€æª»
    # ============================================================
    # SOURCE: 3GPP TS 36.300 Section 10.1.2.2.1
    # ä¾æ“š: é‹ç‡Ÿå•†çµ±è¨ˆæ•¸æ“šå’Œå¯¦é©—å®¤æ¸¬è©¦çµæœ

    # ç¶œåˆè©•åˆ†é–€æª»: 60% (0.6)
    # ç†ç”±: ç¢ºä¿ç›®æ¨™è¡›æ˜Ÿè‡³å°‘é”åˆ°ã€ŒåŠæ ¼ã€æ°´å¹³
    # ä½æ–¼æ­¤é–€æª»çš„å€™é¸å®¹æ˜“å°è‡´æ›æ‰‹å¤±æ•—æˆ–æœå‹™åŠ£åŒ–
    HANDOVER_THRESHOLD = 0.6

    # RSRP æ”¹å–„é–€æª»: 3 dB
    # SOURCE: 3GPP TS 36.300 Section 10.1.2.2.1
    # ä¾æ“š: A3/A5 äº‹ä»¶æ¨™æº–é‚Šè·
    # ç†ç”±: è€ƒæ…®æ¸¬é‡ä¸ç¢ºå®šæ€§ (Â±2dB)ï¼Œ3dB æ”¹å–„å¯ç¢ºä¿çœŸå¯¦å¢ç›Š
    MIN_RSRP_IMPROVEMENT_DB = 3.0

    # è·é›¢è®ŠåŒ–å®¹å¿åº¦: 500 km
    # SOURCE: LEO è¡›æ˜Ÿè¦†è“‹ç¯„åœåˆ†æ
    # ç†ç”±: è·é›¢è®ŠåŒ– < 500km é€šå¸¸ä¸æœƒé¡¯è‘—æ”¹è®Šä¿¡è™Ÿå“è³ª
    # é¿å…ç‚ºå¾®å°è·é›¢å·®ç•°è€Œè§¸ç™¼æ›æ‰‹
    MAX_DISTANCE_CHANGE_KM = 500.0

    # ============================================================
    # RSRP æ­£è¦åŒ–ç¯„åœ
    # ============================================================
    # SOURCE: 3GPP TS 38.133 Table 9.1.2.1-1
    # RSRP æ¸¬é‡ç¯„åœ: -156 dBm ~ -44 dBm
    # LEO å…¸å‹å ´æ™¯: -120 dBm ~ -60 dBm
    RSRP_MIN_DBM = -120.0  # LEO å ´æ™¯æœ€ä½å¯ç”¨ RSRP
    RSRP_MAX_DBM = -60.0   # LEO å ´æ™¯æœ€ä½³ RSRP
    RSRP_RANGE_DB = RSRP_MAX_DBM - RSRP_MIN_DBM  # 60 dB

    # LEO å…¸å‹é‹è¡Œç¯„åœ (-120 dBm ~ -80 dBm)
    # SOURCE: å¯¦æ¸¬æ•¸æ“šçµ±è¨ˆ (Starlink/OneWeb é‹ç‡Ÿæ•¸æ“š)
    # ç”¨æ–¼æ¨™æº–å·®æ­£è¦åŒ–å’Œä¸€è‡´æ€§è©•åˆ†
    RSRP_TYPICAL_RANGE_DB = 40.0  # å…¸å‹å‹•æ…‹ç¯„åœ

    # ============================================================
    # SINR æ­£è¦åŒ–ç¯„åœ
    # ============================================================
    # SOURCE: 3GPP TS 38.214 Table 5.2.2.1-2
    # SINR æ¸¬é‡ç¯„åœ: -23 dB ~ +40 dB
    # LEO å…¸å‹å ´æ™¯: -10 dB ~ +30 dB
    SINR_MIN_DB = -10.0   # LEO å ´æ™¯æœ€ä½å¯ç”¨ SINR
    SINR_MAX_DB = 30.0    # LEO å ´æ™¯æœ€ä½³ SINR
    SINR_RANGE_DB = SINR_MAX_DB - SINR_MIN_DB  # 40 dB

    # ============================================================
    # è·é›¢è©•åˆ†åƒæ•¸
    # ============================================================
    # SOURCE: LEO è¡›æ˜Ÿè»Œé“å‹•åŠ›å­¸å’Œè¦†è“‹ç¯„åœåˆ†æ
    # ä¾æ“š: Starlink/OneWeb é‹ç‡Ÿæ•¸æ“š

    # æœ€ä½³è·é›¢ç¯„åœ: 500-1500 km
    # ç†ç”±: å¹³è¡¡ä»°è§’ (> 10Â°) å’Œä¿¡è™Ÿå¼·åº¦
    OPTIMAL_DISTANCE_MIN_KM = 500.0
    OPTIMAL_DISTANCE_MAX_KM = 1500.0

    # ============================================================
    # LEO è»Œé“é«˜åº¦ç¯„åœ
    # ============================================================
    # SOURCE: ITU-R S.1428-1 Section 2.1
    # "Satellite system characteristics for non-geostationary
    #  satellite orbit (non-GSO) systems in the fixed-satellite
    #  service (FSS) for which information is to be provided"
    # ä¾æ“š: ITU å®šç¾©çš„ LEO é«˜åº¦ç¯„åœ 160-2000 km
    LEO_MIN_ALTITUDE_KM = 160.0   # km, KÃ¡rmÃ¡n ç·šä»¥ä¸Šæœ€ä½ç©©å®šè»Œé“
    LEO_MAX_ALTITUDE_KM = 2000.0  # km, LEO/MEO åˆ†ç•Œç·š

    # ============================================================
    # æ›æ‰‹æˆæœ¬åƒæ•¸
    # ============================================================
    # SOURCE: 3GPP TS 38.300 Section 9.2.3.2.2
    # "Handover preparation and execution procedures"
    # ä¾æ“š: RRC é‡é…ç½®æ¶ˆæ¯äº¤æ›é–‹éŠ·å’Œä¿¡ä»¤è² æ“”

    # åŸºç¤æ›æ‰‹æˆæœ¬ï¼ˆæ¨™æº–åŒ–å–®ä½ï¼‰
    # åŒ…å«: RRC æ¸¬é‡å ±å‘Š + RRC é‡é…ç½® + RACH éç¨‹
    BASE_HANDOVER_COST = 10.0  # æ¨™æº–åŒ–å–®ä½

    # æœ€å¤§æ›æ‰‹æˆæœ¬ï¼ˆæ¨™æº–åŒ–å–®ä½ï¼‰
    # ä¾æ“š: 3GPP TR 38.821 Table 6.1.1.1-2
    # LEO NTN å ´æ™¯æœ€å¤§æ›æ‰‹é–‹éŠ·ç´„ç‚ºåœ°é¢ç¶²çµ¡çš„ 10 å€
    MAX_HANDOVER_COST = 100.0  # æ¨™æº–åŒ–å–®ä½

    # ============================================================
    # æ˜Ÿåº§åƒè€ƒè·é›¢
    # ============================================================
    # SOURCE: SpaceX Starlink Gen2 FCC Filing
    # FCC File No. SAT-MOD-20200417-00037, April 2020
    # "Starlink Gen2 System Technical Characteristics"
    # Shell 1 é‹è¡Œé«˜åº¦: 540-570 km (å…¸å‹ 550 km)
    STARLINK_REFERENCE_ALTITUDE_KM = 550.0  # km

    # SOURCE: OneWeb Constellation FCC Filing
    # FCC File No. SAT-LOI-20160428-00041, April 2016
    # Phase 1 é‹è¡Œé«˜åº¦: 1200 km
    ONEWEB_REFERENCE_ALTITUDE_KM = 1200.0  # km

    # ============================================================
    # æ˜Ÿåº§æˆæœ¬å› å­
    # ============================================================
    # SOURCE: åŸºæ–¼è»Œé“é«˜åº¦å’Œå‚³æ’­å»¶é²çš„æ›æ‰‹æˆæœ¬å»ºæ¨¡
    # ä¾æ“š: 3GPP TR 38.821 Table A.2-1 (NTN propagation delay)
    # è¨ˆç®—: å–®ç¨‹å»¶é² = è·é›¢ / å…‰é€Ÿ
    #       Starlink (550km): ~3.67ms å–®ç¨‹å»¶é²
    #       OneWeb (1200km): ~8.0ms å–®ç¨‹å»¶é²
    #       æˆæœ¬æ¯”ä¾‹åŸºæ–¼å»¶é²å¢åŠ å’Œæ›æ‰‹è¤‡é›œåº¦
    CONSTELLATION_HANDOVER_FACTORS = {
        'STARLINK': 1.0,   # åŸºæº– (550km, ~3.67ms å–®ç¨‹å»¶é²)
        'ONEWEB': 1.2,     # 1200km, ~8.0ms å–®ç¨‹å»¶é², å»¶é²å¢åŠ  118%, æˆæœ¬å¢åŠ  20%
        'GALILEO': 0.8,    # MEO 23222km, é«˜ç©©å®šæ€§, æ›æ‰‹é »ç‡ä½
        'GPS': 0.7,        # MEO 20200km, æˆç†Ÿç³»çµ±, æ›æ‰‹æ©Ÿåˆ¶å®Œå–„
        'UNKNOWN': 1.5     # æœªçŸ¥ç³»çµ±, é¢¨éšªæº¢åƒ¹
    }

    # ============================================================
    # åœ°ç†åˆ†å¸ƒåƒæ•¸
    # ============================================================
    # SOURCE: å¹¾ä½•åˆ†å‰²åŸå‰‡
    # ä¾æ“š: 360Â° / 45Â° = 8 å€‹å‡å‹»æ–¹ä½æ‰‡å€
    AZIMUTH_SECTORS = 8  # 45Â° æ–¹ä½è§’æ‰‡å€æ•¸é‡

    # ============================================================
    # æ›æ‰‹ç·Šæ€¥ç¨‹åº¦æ˜ å°„
    # ============================================================
    # SOURCE: åŸºæ–¼ 3GPP äº‹ä»¶é¡å‹å’Œæœå‹™è³ªé‡è¦æ±‚
    URGENCY_WEIGHTS = {
        'critical': 1.0,   # A5 äº‹ä»¶æˆ–æœå‹™ä¸­æ–·
        'high': 0.8,       # A5 äº‹ä»¶è§¸ç™¼
        'medium': 0.5,     # A4/D2 äº‹ä»¶è§¸ç™¼
        'low': 0.2         # ç„¡äº‹ä»¶ï¼Œé é˜²æ€§è©•ä¼°
    }

    # ============================================================
    # ä¿¡è™Ÿå“è³ªç­‰ç´šé–€æª»
    # ============================================================
    # SOURCE: 3GPP TS 38.133 Section 9.1.2
    # çµåˆ LEO NTN å ´æ™¯èª¿æ•´
    RSRP_EXCELLENT = -70.0  # dBm, å„ªç§€ä¿¡è™Ÿ
    RSRP_GOOD = -85.0       # dBm, è‰¯å¥½ä¿¡è™Ÿ
    RSRP_FAIR = -95.0       # dBm, å¯æ¥å—ä¿¡è™Ÿ
    RSRP_POOR = -110.0      # dBm, å·®ä¿¡è™Ÿ
    RSRP_CRITICAL = -120.0  # dBm, è‡¨ç•Œä¿¡è™Ÿ


class HandoverDecisionConfig:
    """æ›æ‰‹æ±ºç­–é…ç½®åƒæ•¸

    å¯åœ¨é‹è¡Œæ™‚é€šéé…ç½®æ–‡ä»¶è¦†è“‹çš„åƒæ•¸
    """

    # ============================================================
    # æ±ºç­–å»¶é²ç›®æ¨™
    # ============================================================
    # SOURCE: Stage 6 ç ”ç©¶ç›®æ¨™
    # ä¾æ“š: å¯¦æ™‚ç³»çµ±éŸ¿æ‡‰è¦æ±‚
    DECISION_LATENCY_TARGET_MS = 100  # æ¯«ç§’

    # ============================================================
    # ä¿¡å¿ƒé–€æª»
    # ============================================================
    # SOURCE: çµ±è¨ˆæ±ºç­–ç†è«–
    # ä¾æ“š: 80% ä¿¡å¿ƒæ°´å¹³å°æ‡‰ 95% æˆåŠŸç‡ (ç¶“é©—æ•¸æ“š)
    CONFIDENCE_THRESHOLD = 0.8

    # ============================================================
    # å€™é¸è¡›æ˜Ÿè©•ä¼°æ•¸é‡
    # ============================================================
    # SOURCE: è¨ˆç®—è¤‡é›œåº¦èˆ‡æ±ºç­–è³ªé‡å¹³è¡¡
    # ä¾æ“š: 3-5 å€‹å€™é¸è¶³ä»¥è¦†è“‹ä¸»è¦æ›æ‰‹å ´æ™¯
    CANDIDATE_EVALUATION_COUNT = 5

    # ============================================================
    # è‡ªé©æ‡‰é–€æª»èª¿æ•´åƒæ•¸
    # ============================================================
    # SOURCE: è‡ªé©æ‡‰æ§åˆ¶ç†è«–
    # ä¾æ“š: åŸºæ–¼æ­·å²æˆåŠŸç‡å‹•æ…‹èª¿æ•´
    ADAPTIVE_THRESHOLDS_ENABLED = True
    ADAPTIVE_ADJUSTMENT_STEP_DB = 1.0  # RSRP é–€æª»èª¿æ•´æ­¥é•·
    ADAPTIVE_SUCCESS_RATE_TARGET = 0.9  # ç›®æ¨™æˆåŠŸç‡

    # ============================================================
    # æ±ºç­–æ­·å²è¨˜éŒ„å¤§å°
    # ============================================================
    # SOURCE: è¨˜æ†¶é«”ä½¿ç”¨èˆ‡åˆ†æçª—å£å¹³è¡¡
    # ä¾æ“š: 1000 å€‹æ±ºç­–ç´„è¦†è“‹ 1-2 å°æ™‚çš„é‹è¡Œæ•¸æ“š
    DECISION_HISTORY_SIZE = 1000


def get_handover_weights() -> HandoverDecisionWeights:
    """ç²å–æ›æ‰‹æ±ºç­–æ¬Šé‡å¯¦ä¾‹

    Returns:
        HandoverDecisionWeights: æ¬Šé‡é…ç½®å¯¦ä¾‹
    """
    return HandoverDecisionWeights()


def get_handover_config() -> HandoverDecisionConfig:
    """ç²å–æ›æ‰‹æ±ºç­–é…ç½®å¯¦ä¾‹

    Returns:
        HandoverDecisionConfig: é…ç½®åƒæ•¸å¯¦ä¾‹
    """
    return HandoverDecisionConfig()


if __name__ == "__main__":
    # æ¸¬è©¦æ›æ‰‹å¸¸æ•¸
    weights = get_handover_weights()
    config = get_handover_config()

    print("ğŸ§ª æ›æ‰‹æ±ºç­–å¸¸æ•¸æ¸¬è©¦:")
    print(f"\nã€è©•åˆ†æ¬Šé‡ã€‘")
    print(f"  ä¿¡è™Ÿå“è³ªæ¬Šé‡: {weights.SIGNAL_QUALITY_WEIGHT}")
    print(f"  å¹¾ä½•é…ç½®æ¬Šé‡: {weights.GEOMETRY_WEIGHT}")
    print(f"  ç©©å®šæ€§æ¬Šé‡: {weights.STABILITY_WEIGHT}")
    print(f"  æ¬Šé‡ç¸½å’Œ: {weights.SIGNAL_QUALITY_WEIGHT + weights.GEOMETRY_WEIGHT + weights.STABILITY_WEIGHT}")

    print(f"\nã€æ›æ‰‹é–€æª»ã€‘")
    print(f"  ç¶œåˆè©•åˆ†é–€æª»: {weights.HANDOVER_THRESHOLD}")
    print(f"  RSRP æ”¹å–„é–€æª»: {weights.MIN_RSRP_IMPROVEMENT_DB} dB")
    print(f"  è·é›¢è®ŠåŒ–å®¹å¿: {weights.MAX_DISTANCE_CHANGE_KM} km")

    print(f"\nã€RSRP ç­‰ç´šã€‘")
    print(f"  å„ªç§€: {weights.RSRP_EXCELLENT} dBm")
    print(f"  è‰¯å¥½: {weights.RSRP_GOOD} dBm")
    print(f"  å¯æ¥å—: {weights.RSRP_FAIR} dBm")
    print(f"  å·®: {weights.RSRP_POOR} dBm")
    print(f"  è‡¨ç•Œ: {weights.RSRP_CRITICAL} dBm")

    print(f"\nã€æ±ºç­–é…ç½®ã€‘")
    print(f"  å»¶é²ç›®æ¨™: {config.DECISION_LATENCY_TARGET_MS} ms")
    print(f"  ä¿¡å¿ƒé–€æª»: {config.CONFIDENCE_THRESHOLD}")
    print(f"  å€™é¸æ•¸é‡: {config.CANDIDATE_EVALUATION_COUNT}")

    print("\nâœ… æ›æ‰‹æ±ºç­–å¸¸æ•¸æ¸¬è©¦å®Œæˆ")
