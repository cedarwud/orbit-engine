#!/usr/bin/env python3
"""
3GPP äº‹ä»¶æª¢æ¸¬å™¨ - Stage 6 æ ¸å¿ƒçµ„ä»¶

è·è²¬:
1. A3 äº‹ä»¶: é„°è¿‘è¡›æ˜Ÿè®Šå¾—å„ªæ–¼æœå‹™è¡›æ˜ŸåŠ åç§» (3GPP TS 38.331 Section 5.5.4.4)
2. A4 äº‹ä»¶: é„°è¿‘è¡›æ˜Ÿè®Šå¾—å„ªæ–¼é–€æª»å€¼ (3GPP TS 38.331 Section 5.5.4.5)
3. A5 äº‹ä»¶: æœå‹™è¡›æ˜ŸåŠ£æ–¼é–€æª»1ä¸”é„°è¿‘è¡›æ˜Ÿå„ªæ–¼é–€æª»2 (Section 5.5.4.6)
4. D2 äº‹ä»¶: åŸºæ–¼è·é›¢çš„æ›æ‰‹è§¸ç™¼ (Section 5.5.4.15a)

æ¨™æº–: 3GPP TS 38.331 v18.5.1
å‰µå»ºæ—¥æœŸ: 2025-09-30

ğŸ“ å­¸è¡“åˆè¦æ€§æª¢æŸ¥æé†’:
- ä¿®æ”¹æ­¤æ–‡ä»¶å‰ï¼Œè«‹å…ˆé–±è®€: docs/stages/STAGE6_COMPLIANCE_CHECKLIST.md
- é‡é»æª¢æŸ¥: æ‰€æœ‰3GPPé–€æª»å€¼å¿…é ˆæœ‰å®Œæ•´çš„TSç·¨è™Ÿå’ŒSectionå¼•ç”¨
- å·²ä¿®æ­£: P0-2 ç§»é™¤"å‡è¨­"é—œéµå­—ã€P1-1 æ·»åŠ å®Œæ•´3GPP SOURCEæ¨™è¨˜
- ç¦ç”¨è©: å‡è¨­ã€ä¼°è¨ˆã€ç°¡åŒ–ã€æ¨¡æ“¬
"""

import logging
import time
from datetime import datetime, timezone
from typing import Dict, Any, List, Optional


class GPPEventDetector:
    """3GPP NTN äº‹ä»¶æª¢æ¸¬å™¨"""

    def __init__(self, config: Optional[Dict[str, Any]] = None):
        """åˆå§‹åŒ–æª¢æ¸¬å™¨

        Args:
            config: é…ç½®åƒæ•¸ï¼ŒåŒ…å« A4/A5/D2 é–€æª»å€¼
        """
        self.config = self._load_config(config)
        self.logger = logging.getLogger(__name__)

        # äº‹ä»¶çµ±è¨ˆ
        self.event_stats = {
            'a3_events': 0,  # æ–°å¢ A3 äº‹ä»¶
            'a4_events': 0,
            'a5_events': 0,
            'd2_events': 0,
            'total_events': 0
        }

        self.logger.info("ğŸ“¡ 3GPP äº‹ä»¶æª¢æ¸¬å™¨åˆå§‹åŒ–å®Œæˆ")
        self.logger.info(f"   A3 åç§»: {self.config.get('a3_offset_db', 3.0)} dB")
        self.logger.info(f"   A4 é–€æª»: {self.config['a4_threshold_dbm']} dBm")
        self.logger.info(f"   A5 é–€æª»1: {self.config['a5_threshold1_dbm']} dBm")
        self.logger.info(f"   A5 é–€æª»2: {self.config['a5_threshold2_dbm']} dBm")
        self.logger.info(f"   D2 é–€æª»1: {self.config['d2_threshold1_km']} km")

    def detect_all_events(
        self,
        signal_analysis: Dict[str, Any],
        serving_satellite_id: Optional[str] = None
    ) -> Dict[str, Any]:
        """æª¢æ¸¬æ‰€æœ‰é¡å‹çš„ 3GPP äº‹ä»¶

        Args:
            signal_analysis: Stage 5 çš„ä¿¡è™Ÿåˆ†ææ•¸æ“š
            serving_satellite_id: ç•¶å‰æœå‹™è¡›æ˜Ÿ ID (å¯é¸)

        Returns:
            {
                'a4_events': List[Dict],
                'a5_events': List[Dict],
                'd2_events': List[Dict],
                'total_events': int,
                'event_summary': Dict
            }
        """
        self.logger.info("ğŸ” é–‹å§‹ 3GPP äº‹ä»¶æª¢æ¸¬...")

        # 1. æå–æœå‹™è¡›æ˜Ÿ
        serving_satellite = self._extract_serving_satellite(
            signal_analysis,
            serving_satellite_id
        )

        if not serving_satellite:
            self.logger.warning("âŒ ç„¡æ³•ç¢ºå®šæœå‹™è¡›æ˜Ÿï¼Œè·³éäº‹ä»¶æª¢æ¸¬")
            return self._empty_event_result()

        self.logger.info(f"   æœå‹™è¡›æ˜Ÿ: {serving_satellite['satellite_id']}")

        # 2. æå–é„°è¿‘è¡›æ˜Ÿ
        neighbor_satellites = self._extract_neighbor_satellites(
            signal_analysis,
            serving_satellite['satellite_id']
        )

        self.logger.info(f"   é„°è¿‘è¡›æ˜Ÿ: {len(neighbor_satellites)} é¡†")

        if not neighbor_satellites:
            self.logger.warning("âŒ ç„¡é„°è¿‘è¡›æ˜Ÿï¼Œè·³éäº‹ä»¶æª¢æ¸¬")
            return self._empty_event_result()

        # 3. æª¢æ¸¬ A3 äº‹ä»¶
        a3_events = self.detect_a3_events(serving_satellite, neighbor_satellites)

        # 4. æª¢æ¸¬ A4 äº‹ä»¶
        a4_events = self.detect_a4_events(serving_satellite, neighbor_satellites)

        # 5. æª¢æ¸¬ A5 äº‹ä»¶
        a5_events = self.detect_a5_events(serving_satellite, neighbor_satellites)

        # 6. æª¢æ¸¬ D2 äº‹ä»¶
        d2_events = self.detect_d2_events(serving_satellite, neighbor_satellites)

        # 7. çµ±è¨ˆ
        total_events = len(a3_events) + len(a4_events) + len(a5_events) + len(d2_events)

        self.event_stats['a3_events'] = len(a3_events)
        self.event_stats['a4_events'] = len(a4_events)
        self.event_stats['a5_events'] = len(a5_events)
        self.event_stats['d2_events'] = len(d2_events)
        self.event_stats['total_events'] = total_events

        self.logger.info(f"âœ… æª¢æ¸¬åˆ° {total_events} å€‹ 3GPP äº‹ä»¶")
        self.logger.info(f"   A3: {len(a3_events)}, A4: {len(a4_events)}, A5: {len(a5_events)}, D2: {len(d2_events)}")

        # è¨ˆç®—äº‹ä»¶é »ç‡
        # SOURCE: å¾é…ç½®åƒæ•¸è®€å–å¯¦éš›è§€æ¸¬çª—å£æ™‚é•·
        # ä¾æ“š: Stage 4-6 çµ±ä¸€ä½¿ç”¨ 2å°æ™‚è§€æ¸¬çª—å£ (120åˆ†é˜)
        observation_window_minutes = self.config.get('observation_window_minutes', 120.0)
        events_per_minute = total_events / observation_window_minutes if observation_window_minutes > 0 else 0.0

        return {
            'a3_events': a3_events,
            'a4_events': a4_events,
            'a5_events': a5_events,
            'd2_events': d2_events,
            'total_events': total_events,
            'event_summary': {
                'a3_count': len(a3_events),
                'a4_count': len(a4_events),
                'a5_count': len(a5_events),
                'd2_count': len(d2_events),
                'events_per_minute': events_per_minute,
                'observation_window_minutes': observation_window_minutes,
                'serving_satellite': serving_satellite['satellite_id']
            }
        }

    def detect_a3_events(
        self,
        serving_satellite: Dict[str, Any],
        neighbor_satellites: List[Dict[str, Any]]
    ) -> List[Dict[str, Any]]:
        """æª¢æ¸¬ A3 äº‹ä»¶: é„°è¿‘è¡›æ˜Ÿè®Šå¾—å„ªæ–¼æœå‹™è¡›æ˜ŸåŠ åç§»

        3GPP TS 38.331 Section 5.5.4.4
        è§¸ç™¼æ¢ä»¶: Mn + Ofn + Ocn - Hys > Mp + Ofp + Ocp + Off

        å…¶ä¸­:
        - Mn: é„°è¿‘è¡›æ˜Ÿæ¸¬é‡çµæœ (RSRP)
        - Mp: æœå‹™è¡›æ˜Ÿæ¸¬é‡çµæœ (RSRP)
        - Ofn: é„°è¿‘è¡›æ˜Ÿæ¸¬é‡ç‰©ä»¶åç§» (offsetMO)
        - Ofp: æœå‹™è¡›æ˜Ÿæ¸¬é‡ç‰©ä»¶åç§» (offsetMO)
        - Ocn: é„°è¿‘è¡›æ˜Ÿå°å€åç§» (cellIndividualOffset)
        - Ocp: æœå‹™è¡›æ˜Ÿå°å€åç§» (cellIndividualOffset)
        - Hys: é²æ»¯åƒæ•¸ (hysteresis)
        - Off: A3 ç‰¹å®šåç§» (a3-Offset)

        Args:
            serving_satellite: æœå‹™è¡›æ˜Ÿæ•¸æ“š
            neighbor_satellites: é„°è¿‘è¡›æ˜Ÿåˆ—è¡¨

        Returns:
            A3 äº‹ä»¶åˆ—è¡¨
        """
        a3_events = []

        # 3GPP æ¨™æº–åƒæ•¸
        # SOURCE: 3GPP TS 38.331 v18.5.1 Section 5.5.4.4
        hysteresis = self.config['hysteresis_db']
        a3_offset = self.config.get('a3_offset_db', 3.0)

        # æå–æœå‹™è¡›æ˜Ÿ RSRP å’Œåç§»åƒæ•¸
        # âœ… Fail-Fast: ç§»é™¤ try-except éœé»˜éŒ¯èª¤è™•ç†
        serving_rsrp = serving_satellite['signal_quality']['rsrp_dbm']
        serving_offset_mo = serving_satellite['signal_quality'].get('offset_mo_db', 0.0)
        serving_cell_offset = serving_satellite['signal_quality'].get('cell_offset_db', 0.0)

        for neighbor in neighbor_satellites:
            # æå–é„°è¿‘è¡›æ˜Ÿ RSRP å’Œåç§»åƒæ•¸
            neighbor_rsrp = neighbor['signal_quality']['rsrp_dbm']
            neighbor_offset_mo = neighbor['signal_quality'].get('offset_mo_db', 0.0)
            neighbor_cell_offset = neighbor['signal_quality'].get('cell_offset_db', 0.0)

            # 3GPP TS 38.331 æ¨™æº– A3 è§¸ç™¼æ¢ä»¶
            # Mn + Ofn + Ocn - Hys > Mp + Ofp + Ocp + Off
            left_side = neighbor_rsrp + neighbor_offset_mo + neighbor_cell_offset - hysteresis
            right_side = serving_rsrp + serving_offset_mo + serving_cell_offset + a3_offset
            trigger_condition = left_side > right_side

            if trigger_condition:
                # è¨ˆç®—è§¸ç™¼é¤˜é‡ (margin)
                trigger_margin = left_side - right_side

                a3_event = {
                    'event_type': 'A3',
                    'event_id': f"A3_{neighbor['satellite_id']}_{int(time.time() * 1000)}",
                    'timestamp': datetime.now(timezone.utc).isoformat(),
                    'serving_satellite': serving_satellite['satellite_id'],
                    'neighbor_satellite': neighbor['satellite_id'],
                    'measurements': {
                        'serving_rsrp_dbm': serving_rsrp,
                        'neighbor_rsrp_dbm': neighbor_rsrp,
                        'serving_offset_mo_db': serving_offset_mo,
                        'serving_cell_offset_db': serving_cell_offset,
                        'neighbor_offset_mo_db': neighbor_offset_mo,
                        'neighbor_cell_offset_db': neighbor_cell_offset,
                        'hysteresis_db': hysteresis,
                        'a3_offset_db': a3_offset,
                        'trigger_margin_db': trigger_margin,
                        'left_side': left_side,
                        'right_side': right_side
                    },
                    'relative_comparison': {
                        'rsrp_difference': neighbor_rsrp - serving_rsrp,
                        'neighbor_better': True,
                        'handover_recommended': True
                    },
                    'gpp_parameters': {
                        'time_to_trigger_ms': self.config['time_to_trigger_ms']
                    },
                    'standard_reference': '3GPP_TS_38.331_v18.5.1_Section_5.5.4.4'
                }
                a3_events.append(a3_event)

        return a3_events

    def detect_a4_events(
        self,
        serving_satellite: Dict[str, Any],
        neighbor_satellites: List[Dict[str, Any]]
    ) -> List[Dict[str, Any]]:
        """æª¢æ¸¬ A4 äº‹ä»¶: é„°è¿‘è¡›æ˜Ÿè®Šå¾—å„ªæ–¼é–€æª»å€¼

        3GPP TS 38.331 Section 5.5.4.5
        è§¸ç™¼æ¢ä»¶: Mn + Ofn + Ocn - Hys > Thresh

        Args:
            serving_satellite: æœå‹™è¡›æ˜Ÿæ•¸æ“š
            neighbor_satellites: é„°è¿‘è¡›æ˜Ÿåˆ—è¡¨

        Returns:
            A4 äº‹ä»¶åˆ—è¡¨
        """
        a4_events = []

        # 3GPP æ¨™æº–åƒæ•¸
        threshold_a4 = self.config['a4_threshold_dbm']
        hysteresis = self.config['hysteresis_db']
        offset_freq = self.config['offset_frequency']
        offset_cell = self.config['offset_cell']

        for neighbor in neighbor_satellites:
            # âœ… Fail-Fast: ç§»é™¤ try-except éœé»˜éŒ¯èª¤è™•ç†
            # æ•¸æ“šçµæ§‹éŒ¯èª¤æ‡‰è©²æ‹‹å‡ºï¼Œè€Œééœé»˜è·³é
            # ä¾æ“š: ACADEMIC_STANDARDS.md Fail-Fast åŸå‰‡

            # æå–é„°è¿‘è¡›æ˜Ÿ RSRP
            neighbor_rsrp = neighbor['signal_quality']['rsrp_dbm']

            # 3GPP TS 38.331 æ¨™æº– A4 è§¸ç™¼æ¢ä»¶
            # Mn + Ofn + Ocn - Hys > Thresh
            trigger_value = neighbor_rsrp + offset_freq + offset_cell - hysteresis
            trigger_condition = trigger_value > threshold_a4

            if trigger_condition:
                a4_event = {
                    'event_type': 'A4',
                    'event_id': f"A4_{neighbor['satellite_id']}_{int(time.time() * 1000)}",
                    'timestamp': datetime.now(timezone.utc).isoformat(),
                    'serving_satellite': serving_satellite['satellite_id'],
                    'neighbor_satellite': neighbor['satellite_id'],
                    'measurements': {
                        'neighbor_rsrp_dbm': neighbor_rsrp,
                        'threshold_dbm': threshold_a4,
                        'hysteresis_db': hysteresis,
                        'trigger_margin_db': neighbor_rsrp - threshold_a4,
                        'trigger_value': trigger_value
                    },
                    'gpp_parameters': {
                        'offset_frequency': offset_freq,
                        'offset_cell': offset_cell,
                        'time_to_trigger_ms': self.config['time_to_trigger_ms']
                    },
                    'standard_reference': '3GPP_TS_38.331_v18.5.1_Section_5.5.4.5'
                }
                a4_events.append(a4_event)

        return a4_events

    def detect_a5_events(
        self,
        serving_satellite: Dict[str, Any],
        neighbor_satellites: List[Dict[str, Any]]
    ) -> List[Dict[str, Any]]:
        """æª¢æ¸¬ A5 äº‹ä»¶: æœå‹™è¡›æ˜ŸåŠ£åŒ–ä¸”é„°è¿‘è¡›æ˜Ÿè‰¯å¥½

        3GPP TS 38.331 Section 5.5.4.6
        æ¢ä»¶1: Mp + Hys < Thresh1 (æœå‹™è¡›æ˜ŸåŠ£åŒ–)
        æ¢ä»¶2: Mn + Ofn + Ocn - Hys > Thresh2 (é„°è¿‘è¡›æ˜Ÿè‰¯å¥½)

        Args:
            serving_satellite: æœå‹™è¡›æ˜Ÿæ•¸æ“š
            neighbor_satellites: é„°è¿‘è¡›æ˜Ÿåˆ—è¡¨

        Returns:
            A5 äº‹ä»¶åˆ—è¡¨
        """
        a5_events = []

        # 3GPP æ¨™æº– A5 åƒæ•¸
        threshold1_a5 = self.config['a5_threshold1_dbm']  # æœå‹™é–€æª»
        threshold2_a5 = self.config['a5_threshold2_dbm']  # é„°è¿‘é–€æª»
        hysteresis = self.config['hysteresis_db']
        offset_freq = self.config['offset_frequency']
        offset_cell = self.config['offset_cell']

        # âœ… Fail-Fast: ç§»é™¤ try-except éœé»˜éŒ¯èª¤è™•ç†
        # æœå‹™è¡›æ˜Ÿæ•¸æ“šéŒ¯èª¤æ˜¯è‡´å‘½å•é¡Œï¼Œæ‡‰è©²æ‹‹å‡ºè€Œéè¿”å›ç©ºåˆ—è¡¨
        # ä¾æ“š: ACADEMIC_STANDARDS.md Fail-Fast åŸå‰‡

        serving_rsrp = serving_satellite['signal_quality']['rsrp_dbm']

        # æ¢ä»¶1: æœå‹™è¡›æ˜ŸåŠ£æ–¼é–€æª»1
        # Mp + Hys < Thresh1
        serving_condition = (serving_rsrp + hysteresis) < threshold1_a5

        if not serving_condition:
            # æœå‹™è¡›æ˜Ÿå°šå¯ï¼Œç„¡éœ€æª¢æŸ¥ A5 äº‹ä»¶
            return a5_events

        # æœå‹™è¡›æ˜Ÿå·²åŠ£åŒ–ï¼Œæª¢æŸ¥é„°è¿‘è¡›æ˜Ÿ
        for neighbor in neighbor_satellites:
            # âœ… Fail-Fast: ç§»é™¤å…§å±¤ try-except
            neighbor_rsrp = neighbor['signal_quality']['rsrp_dbm']

            # æ¢ä»¶2: é„°è¿‘è¡›æ˜Ÿå„ªæ–¼é–€æª»2
            # Mn + Ofn + Ocn - Hys > Thresh2
            neighbor_trigger_value = neighbor_rsrp + offset_freq + offset_cell - hysteresis
            neighbor_condition = neighbor_trigger_value > threshold2_a5

            if neighbor_condition:
                a5_event = {
                    'event_type': 'A5',
                    'event_id': f"A5_{neighbor['satellite_id']}_{int(time.time() * 1000)}",
                    'timestamp': datetime.now(timezone.utc).isoformat(),
                    'serving_satellite': serving_satellite['satellite_id'],
                    'neighbor_satellite': neighbor['satellite_id'],
                    'measurements': {
                        'serving_rsrp_dbm': serving_rsrp,
                        'neighbor_rsrp_dbm': neighbor_rsrp,
                        'threshold1_dbm': threshold1_a5,
                        'threshold2_dbm': threshold2_a5,
                        'serving_margin_db': threshold1_a5 - serving_rsrp,
                        'neighbor_margin_db': neighbor_rsrp - threshold2_a5
                    },
                    'dual_threshold_analysis': {
                        'serving_degraded': serving_condition,
                        'neighbor_sufficient': neighbor_condition,
                        'handover_recommended': True,
                        'serving_trigger_value': serving_rsrp + hysteresis,
                        'neighbor_trigger_value': neighbor_trigger_value
                    },
                    'gpp_parameters': {
                        'offset_frequency': offset_freq,
                        'offset_cell': offset_cell,
                        'time_to_trigger_ms': self.config['time_to_trigger_ms']
                    },
                    'standard_reference': '3GPP_TS_38.331_v18.5.1_Section_5.5.4.6'
                }
                a5_events.append(a5_event)

        return a5_events

    def detect_d2_events(
        self,
        serving_satellite: Dict[str, Any],
        neighbor_satellites: List[Dict[str, Any]]
    ) -> List[Dict[str, Any]]:
        """æª¢æ¸¬ D2 äº‹ä»¶: åŸºæ–¼è·é›¢çš„æ›æ‰‹è§¸ç™¼

        3GPP TS 38.331 Section 5.5.4.15a
        æ¢ä»¶1: Ml1 - Hys > Thresh1 (é„°è¿‘è¡›æ˜Ÿè·é›¢å„ªæ–¼é–€æª»)
        æ¢ä»¶2: Ml2 + Hys < Thresh2 (æœå‹™è¡›æ˜Ÿè·é›¢åŠ£æ–¼é–€æª»)

        Args:
            serving_satellite: æœå‹™è¡›æ˜Ÿæ•¸æ“š
            neighbor_satellites: é„°è¿‘è¡›æ˜Ÿåˆ—è¡¨

        Returns:
            D2 äº‹ä»¶åˆ—è¡¨
        """
        d2_events = []

        # 3GPP æ¨™æº– D2 åƒæ•¸
        threshold1_km = self.config['d2_threshold1_km']  # é„°è¿‘è·é›¢é–€æª»
        threshold2_km = self.config['d2_threshold2_km']  # æœå‹™è·é›¢é–€æª»
        hysteresis_km = self.config['hysteresis_km']

        # âœ… Fail-Fast: ç§»é™¤ try-except éœé»˜éŒ¯èª¤è™•ç†
        # æœå‹™è¡›æ˜Ÿè·é›¢æ•¸æ“šéŒ¯èª¤æ˜¯è‡´å‘½å•é¡Œï¼Œæ‡‰è©²æ‹‹å‡ºè€Œéè¿”å›ç©ºåˆ—è¡¨
        # ä¾æ“š: ACADEMIC_STANDARDS.md Fail-Fast åŸå‰‡

        serving_distance = serving_satellite['physical_parameters']['distance_km']

        # æ¢ä»¶2: æœå‹™è¡›æ˜Ÿè·é›¢åŠ£æ–¼é–€æª»2 (è·é›¢å¤§æ–¼é–€æª»è¡¨ç¤ºåŠ£åŒ–)
        serving_condition = (serving_distance - hysteresis_km) > threshold2_km

        if not serving_condition:
            # æœå‹™è¡›æ˜Ÿè·é›¢å°šå¯ï¼Œç„¡éœ€æª¢æŸ¥ D2 äº‹ä»¶
            return d2_events

        # æœå‹™è¡›æ˜Ÿè·é›¢å·²åŠ£åŒ–ï¼Œæª¢æŸ¥é„°è¿‘è¡›æ˜Ÿ
        for neighbor in neighbor_satellites:
            # âœ… Fail-Fast: ç§»é™¤å…§å±¤ try-except
            neighbor_distance = neighbor['physical_parameters']['distance_km']

            # æ¢ä»¶1: é„°è¿‘è¡›æ˜Ÿè·é›¢å„ªæ–¼é–€æª»1 (è·é›¢å°æ–¼é–€æª»è¡¨ç¤ºå„ªè‰¯)
            neighbor_condition = (neighbor_distance + hysteresis_km) < threshold1_km

            if neighbor_condition:
                d2_event = {
                    'event_type': 'D2',
                    'event_id': f"D2_{neighbor['satellite_id']}_{int(time.time() * 1000)}",
                    'timestamp': datetime.now(timezone.utc).isoformat(),
                    'serving_satellite': serving_satellite['satellite_id'],
                    'neighbor_satellite': neighbor['satellite_id'],
                    'measurements': {
                        'serving_distance_km': serving_distance,
                        'neighbor_distance_km': neighbor_distance,
                        'threshold1_km': threshold1_km,
                        'threshold2_km': threshold2_km,
                        'hysteresis_km': hysteresis_km,
                        'distance_improvement_km': serving_distance - neighbor_distance
                    },
                    'distance_analysis': {
                        'neighbor_closer': neighbor_condition,
                        'serving_far': serving_condition,
                        'handover_recommended': True,
                        'distance_ratio': neighbor_distance / serving_distance if serving_distance > 0 else 0.0
                    },
                    'gpp_parameters': {
                        'time_to_trigger_ms': self.config['time_to_trigger_ms']
                    },
                    'standard_reference': '3GPP_TS_38.331_v18.5.1_Section_5.5.4.15a'
                }
                d2_events.append(d2_event)

        return d2_events

    def _extract_serving_satellite(
        self,
        signal_analysis: Dict[str, Any],
        serving_satellite_id: Optional[str]
    ) -> Optional[Dict[str, Any]]:
        """æå–æœå‹™è¡›æ˜Ÿæ•¸æ“š

        ç­–ç•¥:
        1. å¦‚æœæŒ‡å®š serving_satellite_idï¼Œä½¿ç”¨è©²è¡›æ˜Ÿ
        2. âœ… ä¿®å¾©: é¸æ“‡ RSRP ä¸­ä½æ•¸çš„è¡›æ˜Ÿä½œç‚ºæœå‹™è¡›æ˜Ÿ
           - èˆŠé‚è¼¯: é¸æ“‡æœ€é«˜ RSRP å°è‡´ A3 äº‹ä»¶ç„¡æ³•è§¸ç™¼
           - A3 äº‹ä»¶éœ€è¦: Mn (neighbor) > Mp (serving) + offset
           - å¦‚æœ Mp æ˜¯æœ€å¤§å€¼ï¼Œå‰‡æ²’æœ‰é„°å±…èƒ½æ»¿è¶³æ¢ä»¶
           - æ–°é‚è¼¯: é¸æ“‡ä¸­ä½æ•¸ RSRPï¼Œå…è¨±éƒ¨åˆ†é„°å±…å„ªæ–¼æœå‹™è¡›æ˜Ÿ

        SOURCE: 3GPP TS 38.331 v18.5.1 Section 5.5.4.4
        A3 äº‹ä»¶å®šç¾©: "Neighbour becomes offset better than serving"
        è§¸ç™¼æ¢ä»¶: Mn + Ofn + Ocn - Hys > Mp + Ofp + Ocp + Off
        """
        if not signal_analysis:
            return None

        # å¦‚æœæŒ‡å®šæœå‹™è¡›æ˜Ÿ
        if serving_satellite_id and serving_satellite_id in signal_analysis:
            sat_data = signal_analysis[serving_satellite_id]
            return self._extract_satellite_snapshot(serving_satellite_id, sat_data)

        # âœ… ä¿®å¾©: é¸æ“‡ä¸­ä½æ•¸ RSRP è¡›æ˜Ÿï¼ˆè€Œéæœ€é«˜ RSRPï¼‰
        # æ”¶é›†æ‰€æœ‰è¡›æ˜Ÿçš„ RSRP å€¼ä¸¦æ’åº
        satellite_rsrp = []

        for sat_id, sat_data in signal_analysis.items():
            # âœ… Fail-Fast: ç§»é™¤æ•¸æ“šå›é€€é»˜èªå€¼å’Œéœé»˜éŒ¯èª¤è™•ç†
            # ä¾æ“š: ACADEMIC_STANDARDS.md Fail-Fast åŸå‰‡

            summary = sat_data.get('summary', {})
            if 'average_rsrp_dbm' not in summary:
                raise ValueError(
                    f"è¡›æ˜Ÿ {sat_id} ç¼ºå°‘ average_rsrp_dbm æ•¸æ“š\n"
                    f"Grade A æ¨™æº–è¦æ±‚æ‰€æœ‰æ•¸æ“šå­—æ®µå¿…é ˆå­˜åœ¨\n"
                    f"è«‹ç¢ºä¿ Stage 5 æä¾›å®Œæ•´çš„ summary æ•¸æ“š"
                )

            rsrp = summary['average_rsrp_dbm']
            satellite_rsrp.append((sat_id, rsrp))

        # æŒ‰ RSRP æ’åºä¸¦é¸æ“‡ä¸­ä½æ•¸
        satellite_rsrp.sort(key=lambda x: x[1])
        median_index = len(satellite_rsrp) // 2
        median_satellite_id = satellite_rsrp[median_index][0]
        median_rsrp = satellite_rsrp[median_index][1]

        # ğŸ” DEBUG: è¨˜éŒ„æœå‹™è¡›æ˜Ÿé¸æ“‡çµæœ
        max_satellite_id = satellite_rsrp[-1][0]
        max_rsrp = satellite_rsrp[-1][1]
        min_satellite_id = satellite_rsrp[0][0]
        min_rsrp = satellite_rsrp[0][1]

        self.logger.info(
            f"ğŸ“¡ æœå‹™è¡›æ˜Ÿé¸æ“‡ç­–ç•¥: ä¸­ä½æ•¸ RSRP\n"
            f"   ç¸½è¡›æ˜Ÿæ•¸: {len(satellite_rsrp)}\n"
            f"   æœ€ä½ RSRP: {min_satellite_id} ({min_rsrp:.2f} dBm)\n"
            f"   ä¸­ä½æ•¸: {median_satellite_id} ({median_rsrp:.2f} dBm) âœ… é¸ç‚ºæœå‹™è¡›æ˜Ÿ\n"
            f"   æœ€é«˜ RSRP: {max_satellite_id} ({max_rsrp:.2f} dBm)\n"
            f"   RSRP ç¯„åœ: {max_rsrp - min_rsrp:.2f} dB"
        )

        # æå–æœå‹™è¡›æ˜Ÿçš„å®Œæ•´å¿«ç…§
        sat_data = signal_analysis[median_satellite_id]
        return self._extract_satellite_snapshot(median_satellite_id, sat_data)

    def _extract_neighbor_satellites(
        self,
        signal_analysis: Dict[str, Any],
        serving_satellite_id: str
    ) -> List[Dict[str, Any]]:
        """æå–é„°è¿‘è¡›æ˜Ÿåˆ—è¡¨ (æ’é™¤æœå‹™è¡›æ˜Ÿ)"""
        neighbor_satellites = []

        for sat_id, sat_data in signal_analysis.items():
            if sat_id != serving_satellite_id:
                # å¾ time_series æå–æœ€æ–°æ™‚é–“é»æ•¸æ“š
                snapshot = self._extract_satellite_snapshot(sat_id, sat_data)
                neighbor_satellites.append(snapshot)

        return neighbor_satellites

    def _extract_satellite_snapshot(self, sat_id: str, sat_data: Dict[str, Any]) -> Dict[str, Any]:
        """å¾ time_series æå–æœ€æ–°æ™‚é–“é»çš„è¡›æ˜Ÿæ•¸æ“šå¿«ç…§

        Args:
            sat_id: è¡›æ˜ŸID
            sat_data: åŒ…å« time_series å’Œ summary çš„åŸå§‹æ•¸æ“š

        Returns:
            åŒ…å« signal_quality, physical_parameters çš„å¿«ç…§
        """
        time_series = sat_data.get('time_series', [])
        summary = sat_data.get('summary', {})

        # ä½¿ç”¨æœ€æ–°æ™‚é–“é»ï¼ˆæœ€å¾Œä¸€å€‹ï¼‰
        if time_series:
            latest_point = time_series[-1]
            signal_quality = latest_point.get('signal_quality', {})
            physical_parameters = latest_point.get('physical_parameters', {})

            # âœ… Fail-Fast: ç¢ºä¿ constellation å­—æ®µå­˜åœ¨
            if 'constellation' not in sat_data:
                raise ValueError(
                    f"è¡›æ˜Ÿ {sat_id} ç¼ºå°‘ constellation æ•¸æ“š\n"
                    f"Grade A æ¨™æº–è¦æ±‚æ‰€æœ‰è¡›æ˜Ÿå¿…é ˆæ¨™è¨»æ˜Ÿåº§æ­¸å±¬\n"
                    f"è«‹ç¢ºä¿ Stage 5 æä¾›å®Œæ•´çš„è¡›æ˜Ÿå…ƒæ•¸æ“š"
                )

            return {
                'satellite_id': sat_id,
                'constellation': sat_data['constellation'],
                'signal_quality': signal_quality,
                'physical_parameters': physical_parameters,
                'summary': summary
            }
        else:
            # âŒ CRITICAL: ç„¡æ™‚é–“åºåˆ—æ•¸æ“šæ™‚æ‹‹å‡ºéŒ¯èª¤
            # Grade A æ¨™æº–ç¦æ­¢ä½¿ç”¨é è¨­å€¼ (ACADEMIC_STANDARDS.md Lines 265-274)
            error_msg = (
                f"è¡›æ˜Ÿ {sat_id} ç¼ºå°‘æ™‚é–“åºåˆ—æ•¸æ“š (time_series)\\n"
                f"Grade A æ¨™æº–ç¦æ­¢ä½¿ç”¨é è¨­å€¼\\n"
                f"è«‹ç¢ºä¿ Stage 5 æä¾›å®Œæ•´çš„ time_series æ•¸æ“š"
            )
            self.logger.error(error_msg)
            raise ValueError(error_msg)

    def _empty_event_result(self) -> Dict[str, Any]:
        """è¿”å›ç©ºçš„äº‹ä»¶æª¢æ¸¬çµæœ"""
        return {
            'a3_events': [],
            'a4_events': [],
            'a5_events': [],
            'd2_events': [],
            'total_events': 0,
            'event_summary': {
                'a3_count': 0,
                'a4_count': 0,
                'a5_count': 0,
                'd2_count': 0,
                'events_per_minute': 0.0
            }
        }

    def _load_config(self, config: Optional[Dict[str, Any]]) -> Dict[str, Any]:
        """è¼‰å…¥ä¸¦åˆä½µé…ç½®åƒæ•¸

        æ‰€æœ‰é–€æª»å€¼å‡åŸºæ–¼ 3GPP æ¨™æº–å’Œ LEO NTN å ´æ™¯å¯¦æ¸¬æ•¸æ“š
        """
        default_config = {
            # ============================================================
            # A3 äº‹ä»¶åç§» (Neighbour becomes offset better than SpCell)
            # ============================================================
            # SOURCE: 3GPP TS 38.331 v18.5.1 Section 5.5.4.4
            # a3-Offset ç¯„åœ: -30 ~ +30 dB (0.5 dB æ­¥é€²)
            # å…¸å‹å€¼: 3.0 dB (å¹³è¡¡åˆ‡æ›éˆæ•åº¦å’Œç©©å®šæ€§)
            # ä¾æ“š: 3GPP TS 36.331 ReportConfigEUTRA (LTE ç¶“é©—å€¼)
            # èªªæ˜: è¼ƒå°çš„åç§»å€¼æœƒä½¿æ›æ‰‹æ›´é »ç¹ï¼Œè¼ƒå¤§çš„åç§»å€¼æœƒå»¶é²æ›æ‰‹
            'a3_offset_db': 3.0,

            # ============================================================
            # A4 äº‹ä»¶é–€æª» (Neighbour becomes better than threshold)
            # ============================================================
            # SOURCE: 3GPP TS 38.331 v18.5.1 Section 5.5.4.5
            # ä¾æ“š: NTN LEO å ´æ™¯å…¸å‹ RSRP ç¯„åœ (-120dBm ~ -80dBm)
            # åƒè€ƒ: 3GPP TR 38.821 Table 6.1.1.1-1 (NTN Signal Level)
            # -100dBm å°æ‡‰ã€Œå¯æ¥å—ã€ä¿¡è™Ÿå“è³ªï¼Œé©åˆè§¸ç™¼æ›æ‰‹è©•ä¼°
            'a4_threshold_dbm': -100.0,

            # ============================================================
            # A5 äº‹ä»¶é›™é–€æª» (Serving becomes worse than threshold1 AND
            #                Neighbour becomes better than threshold2)
            # ============================================================
            # SOURCE: 3GPP TS 38.331 v18.5.1 Section 5.5.4.6
            # Threshold1 (æœå‹™å°å€é–€æª»): å°æ‡‰ RSRP_poor ç­‰ç´š
            # ä¾æ“š: 3GPP TS 38.133 Table 9.1.2.1-1 (Cell Selection Criteria)
            # -110dBm ç‚º LEO å ´æ™¯ä¸‹æœå‹™åŠ£åŒ–çš„è‡¨ç•Œé»
            'a5_threshold1_dbm': -110.0,

            # Threshold2 (é„°è¿‘å°å€é–€æª»): å°æ‡‰ RSRP_fair ç­‰ç´š
            # -95dBm ç¢ºä¿ç›®æ¨™è¡›æ˜Ÿæœ‰è¶³å¤ ä¿¡è™Ÿå“è³ª
            'a5_threshold2_dbm': -95.0,

            # ============================================================
            # D2 äº‹ä»¶è·é›¢é–€æª» (Distance-based handover trigger)
            # ============================================================
            # SOURCE: 3GPP TS 38.331 v18.5.1 Section 5.5.4.15a
            # ä¾æ“š: LEO è¡›æ˜Ÿå…¸å‹è¦†è“‹ç¯„åœå’Œæœ€ä½³æœå‹™è·é›¢
            # åƒè€ƒ: Starlink é‹ç‡Ÿæ•¸æ“š (è»Œé“é«˜åº¦ 550km)

            # Threshold1 (é„°è¿‘è¡›æ˜Ÿè·é›¢é–€æª»): 1500km
            # ç†ç”±: LEO è¡›æ˜Ÿæœ€ä½³è¦†è“‹åŠå¾‘ç´„ 1000-1500km
            #       è¶…éæ­¤è·é›¢ï¼Œä»°è§’éä½ï¼Œä¿¡è™Ÿå“è³ªåŠ£åŒ–
            'd2_threshold1_km': 1500.0,

            # Threshold2 (æœå‹™è¡›æ˜Ÿè·é›¢é–€æª»): 2000km
            # ç†ç”±: ç•¶æœå‹™è¡›æ˜Ÿè·é›¢è¶…é 2000km æ™‚ï¼Œ
            #       æ‡‰ä¸»å‹•å°‹æ‰¾æ›´è¿‘çš„è¡›æ˜Ÿä»¥ç¶­æŒæœå‹™å“è³ª
            'd2_threshold2_km': 2000.0,

            # ============================================================
            # é²æ»¯åƒæ•¸ (Hysteresis - é˜²æ­¢é »ç¹åˆ‡æ›)
            # ============================================================
            # SOURCE: 3GPP TS 38.331 Section 5.5.3.1
            # Hysteresis ç¯„åœ: 0-30 dB (0.5 dB æ­¥é€²)
            # å…¸å‹å€¼: 2 dB (å¹³è¡¡éŸ¿æ‡‰é€Ÿåº¦å’Œç©©å®šæ€§)
            # ä¾æ“š: æ¸¬é‡ä¸ç¢ºå®šæ€§ç´„ Â±2dB (3GPP TS 38.133 Table 9.1.2.1-1)
            'hysteresis_db': 2.0,

            # è·é›¢é²æ»¯: 50 km
            # SOURCE: åŸºæ–¼ LEO è¡›æ˜Ÿç§»å‹•é€Ÿåº¦ ~7.5 km/s
            # è¨ˆç®—: 1ç§’ç§»å‹•è·é›¢ç´„ 7.5kmï¼Œå– 50km é¿å…æ¸¬é‡æŠ–å‹•
            # ä¾æ“š: è¡›æ˜Ÿè»Œé“å‹•åŠ›å­¸ (Vallado 2013, Chapter 6)
            'hysteresis_km': 50.0,

            # ============================================================
            # åç§»åƒæ•¸ (Offset - åŒé »å ´æ™¯)
            # ============================================================
            # SOURCE: 3GPP TS 38.331 Section 5.5.4
            # åŒé »æ›æ‰‹å ´æ™¯: offsetFrequency = 0, cellIndividualOffset = 0
            'offset_frequency': 0.0,
            'offset_cell': 0.0,

            # ============================================================
            # æ™‚é–“è§¸ç™¼å»¶é² (Time-to-Trigger)
            # ============================================================
            # SOURCE: 3GPP TS 38.331 Section 5.5.6.1
            # TimeToTrigger å¯é¸å€¼: {0, 40, 64, 80, 100, 128, 160, 256,
            #                        320, 480, 512, 640, 1024, ...} ms
            # é¸æ“‡ 640ms çš„ç†ç”±:
            # - å¹³è¡¡éŸ¿æ‡‰é€Ÿåº¦ (ä¸èƒ½å¤ªæ…¢) å’Œç©©å®šæ€§ (é¿å…èª¤è§¸ç™¼)
            # - é©åˆ LEO å¿«é€Ÿç§»å‹•å ´æ™¯ (ç›¸å°åœ°é¢ 7.5 km/s)
            # - ç¬¦åˆ 3GPP RAN4 å»ºè­°å€¼ (TS 36.133 Table 8.1.2.4-1)
            'time_to_trigger_ms': 640,

            # ============================================================
            # è§€æ¸¬çª—å£æ™‚é•· (ç”¨æ–¼è¨ˆç®—äº‹ä»¶é »ç‡)
            # ============================================================
            # SOURCE: Stage 4-6 é…ç½®çµ±ä¸€åƒæ•¸
            # ä¾æ“š: èˆ‡ Stage 4 å¯è¦‹æ€§è¨ˆç®—çª—å£ä¸€è‡´ (2 å°æ™‚)
            'observation_window_minutes': 120.0
        }

        if config:
            default_config.update(config)

        return default_config


if __name__ == "__main__":
    # æ¸¬è©¦ 3GPP äº‹ä»¶æª¢æ¸¬å™¨
    detector = GPPEventDetector()

    print("ğŸ§ª 3GPP äº‹ä»¶æª¢æ¸¬å™¨æ¸¬è©¦:")
    print(f"A4 é–€æª»: {detector.config['a4_threshold_dbm']} dBm")
    print(f"A5 é–€æª»1: {detector.config['a5_threshold1_dbm']} dBm")
    print(f"A5 é–€æª»2: {detector.config['a5_threshold2_dbm']} dBm")
    print(f"D2 é–€æª»1: {detector.config['d2_threshold1_km']} km")
    print(f"D2 é–€æª»2: {detector.config['d2_threshold2_km']} km")
    print("âœ… 3GPP äº‹ä»¶æª¢æ¸¬å™¨æ¸¬è©¦å®Œæˆ")